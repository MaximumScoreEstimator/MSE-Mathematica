(* Content-type: application/vnd.wolfram.mathematica *)

(*** Wolfram Notebook File ***)
(* http://www.wolfram.com/nb *)

(* CreatedBy='Mathematica 9.0' *)

(*CacheID: 234*)
(* Internal cache information:
NotebookFileLineBreakTest
NotebookFileLineBreakTest
NotebookDataPosition[       157,          7]
NotebookDataLength[    105576,       2724]
NotebookOptionsPosition[     99818,       2528]
NotebookOutlinePosition[    100548,       2556]
CellTagsIndexPosition[    100415,       2550]
WindowFrame->Normal*)

(* Beginning of Notebook Content *)
Notebook[{

Cell[CellGroupData[{
Cell["matching.nb", "Section",
 CellChangeTimes->{{3.62600628385137*^9, 3.626006284835745*^9}, {
  3.6260709487170696`*^9, 3.6260709533480415`*^9}, {3.626096953477417*^9, 
  3.6260969551364455`*^9}, {3.6261707215015993`*^9, 3.6261707234205446`*^9}}],

Cell[CellGroupData[{

Cell["For the Developer", "Subsubsection",
 CellChangeTimes->{{3.5819225877880845`*^9, 3.581922592443351*^9}}],

Cell["\<\
AutoGeneratedPackage is an option for notebooks that specifies whether a \
package is automatically created when a notebook that contains initialization \
cells or groups is saved.\
\>", "Text",
 CellChangeTimes->{{3.5808982533077106`*^9, 3.580898259632072*^9}}],

Cell[BoxData[
 RowBox[{"SetOptions", "[", 
  RowBox[{
   RowBox[{"InputNotebook", "[", "]"}], ",", 
   RowBox[{"AutoGeneratedPackage", "\[Rule]", "Automatic"}]}], "]"}]], "Input"],

Cell[BoxData[
 RowBox[{
  RowBox[{"$HistoryLength", "=", "0"}], ";"}]], "Input",
 CellChangeTimes->{{3.5816697178146343`*^9, 3.581669717815634*^9}}],

Cell[BoxData[
 RowBox[{"ClearSystemCache", "[", "]"}]], "Input",
 CellChangeTimes->{{3.581669726757145*^9, 3.5816697379287844`*^9}}]
}, Open  ]],

Cell[CellGroupData[{

Cell["generateAssignmentMatrix[payoffs,quotaU,quotaD]", "Subsection",
 CellChangeTimes->{{3.626169503603243*^9, 3.62616950426756*^9}, 
   3.6261707398111696`*^9, 3.6263308937397165`*^9}],

Cell["\<\
generateAssignmentMatrix - Generates the optimal assignment of matches from \
the given matrix of payoffs for each match. 
\t\t\t\tIn an assignment matrix, each entry (i,j) is 1 if i and j are matched \
and 0 otherwise. 
\t\t\t\t\t
\tParameters:
\t\tpayoffs - A list of matrices (one for each market) where the (i,j)th \
element is
\t\t\t  the total production from matching i and j. 
\t\tquotaU - Maximum number of partners each upstream agent can have. Default \
= 1. 
\t\tquotaD - Maximum number of partners each downstream agent can have. \
Default = 1. 
\t\t
\t\tquotaU and (or) quotaD can be lists of specific quotas.\
\>", "Text",
 CellChangeTimes->{{3.611658004382143*^9, 3.6116580497034025`*^9}, {
  3.611923247193398*^9, 3.6119232502275777`*^9}, {3.642293485630185*^9, 
  3.642293511749206*^9}, {3.687875948455463*^9, 3.687875948552136*^9}},
 Background->RGBColor[1, 0.9, 0.8]],

Cell[BoxData[{
 RowBox[{
  RowBox[{"ClearAll", "[", "generateAssignmentMatrix", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Options", "[", "generateAssignmentMatrix", "]"}], "=", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"linearProgrammingOptions", "\[Rule]", "Null"}], ",", 
     RowBox[{"rationalizeResult", "\[Rule]", "True"}], ",", 
     RowBox[{"domain", "\[Rule]", "Integers"}]}], "}"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"generateAssignmentMatrix", "::", "usage"}], "=", 
   "\"\<\nGenerates the optimal assignment of matches from the given matrix \
of payoffs for each match. The optimal assignment is the one that maximizes \
the total payoff (i.e. the sum of all payoffs) in a market. In an assignment \
matrix, each entry (i,j) is 1 if i and j are matched and 0 otherwise. The \
quota can be a number (the same for all streams) or a list that sets a \
specific quota per agent.\nNotice that the quota is max number of matches per \
agent ( so in the data the real number of matches could be lower than the \
max).\>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"generateAssignmentMatrix", "[", 
    RowBox[{"payoffs_", ",", 
     RowBox[{"quotaU_:", "1"}], ",", 
     RowBox[{"quotaD_:", "1"}], ",", 
     RowBox[{"options___", "?", "OptionQ"}]}], "]"}], ":=", 
   "\[IndentingNewLine]", 
   RowBox[{"Block", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "realorint", ",", "rationalize", ",", "lpOptions", ",", "numU", ",", 
       "numD", ",", "m1", ",", "m2", ",", "m3", ",", "m", ",", "b", ",", 
       "matchMatrix", ",", "result"}], "}"}], ",", 
     RowBox[{
      RowBox[{
       RowBox[{"{", 
        RowBox[{"realorint", ",", "rationalize", ",", "lpOptions"}], "}"}], 
       "=", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{
         "domain", ",", "rationalizeResult", ",", 
          "linearProgrammingOptions"}], "}"}], "/.", 
        RowBox[{"Flatten", "[", 
         RowBox[{"{", 
          RowBox[{"options", ",", 
           RowBox[{"Options", "[", "generateAssignmentMatrix", "]"}]}], "}"}],
          "]"}]}]}], ";", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"numU", ",", "numD"}], "}"}], "=", 
       RowBox[{"Dimensions", "[", "payoffs", "]"}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{"In", " ", "this", " ", "function"}], ",", 
        RowBox[{
        "there", " ", "are", " ", "two", " ", "sides", " ", "to", " ", "the", 
         " ", "market"}], ",", 
        RowBox[{"U", " ", 
         RowBox[{"(", "pstream", ")"}], " ", "and", " ", "D", " ", 
         RowBox[{
          RowBox[{"(", "ownstream", ")"}], ".", "i"}], " ", "will", " ", 
         "index", " ", "upstream", " ", "firms", " ", "and", " ", "j", " ", 
         "will", " ", "index", " ", "downstream", " ", 
         RowBox[{"firms", "."}]}]}], "*)"}], "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{
        "m1", " ", "is", " ", "the", " ", "first", " ", "third", " ", "of", 
         " ", "the", " ", "constraint", " ", 
         RowBox[{"matrix", ".", "It"}], " ", "represents", " ", "the", " ", 
         RowBox[{"constraint", "\\", "sum"}], 
         RowBox[{"{", 
          RowBox[{"x_", " ", 
           RowBox[{"{", "ij", "}"}]}], "}"}], "_", " ", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"i", "=", "1"}], "}"}], "^", "n"}]}], "\[LessEqual]", 
        RowBox[{"quotaD", " ", "for", " ", "all", " ", "j"}]}], "*)"}], 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"m1", "=", 
       RowBox[{"SparseArray", "[", 
        RowBox[{"ArrayFlatten", "[", 
         RowBox[{"Outer", "[", 
          RowBox[{"Times", ",", 
           RowBox[{"SparseArray", "[", 
            RowBox[{"IdentityMatrix", "[", "numU", "]"}], "]"}], ",", 
           RowBox[{"{", 
            RowBox[{"Table", "[", 
             RowBox[{"1", ",", 
              RowBox[{"{", "numD", "}"}]}], "]"}], "}"}]}], "]"}], "]"}], 
        "]"}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{
        "m2", " ", "is", " ", "the", " ", "second", " ", "third", " ", "of", 
         " ", "the", " ", "constraint", " ", 
         RowBox[{"matrix", ".", "It"}], " ", "represents", " ", "the", " ", 
         RowBox[{"constraint", "\\", "sum"}], 
         RowBox[{"{", 
          RowBox[{"x_", " ", 
           RowBox[{"{", "ij", "}"}]}], "}"}], "_", " ", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"j", "=", "1"}], "}"}], "^", "n"}]}], "\[LessEqual]", 
        RowBox[{"quotaU", " ", "for", " ", "all", " ", "i"}]}], "*)"}], 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"m2", "=", 
       RowBox[{"SparseArray", "[", 
        RowBox[{"ArrayFlatten", "[", 
         RowBox[{"Outer", "[", 
          RowBox[{"Times", ",", 
           RowBox[{"{", 
            RowBox[{"Table", "[", 
             RowBox[{"1", ",", 
              RowBox[{"{", "numU", "}"}]}], "]"}], "}"}], ",", 
           RowBox[{"SparseArray", "[", 
            RowBox[{"IdentityMatrix", "[", "numD", "]"}], "]"}]}], "]"}], 
         "]"}], "]"}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{
       "m3", " ", "is", " ", "the", " ", "last", " ", "third", " ", "of", " ",
         "the", " ", "constraint", " ", 
        RowBox[{"matrix", ".", "It"}], " ", "represents", " ", "the", " ", 
        "constraint", " ", "that", " ", "each", " ", "pair", " ", "of", " ", 
        "people", " ", "can", " ", "only", " ", "match", " ", "with", " ", 
        "each", " ", "other", " ", 
        RowBox[{"once", "."}]}], "*)"}], 
      RowBox[{"m3", "=", 
       RowBox[{"SparseArray", "[", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{"i_", ",", "i_"}], "}"}], "\[Rule]", "1"}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"numU", "*", "numD"}], ",", 
           RowBox[{"numU", "*", "numD"}]}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"m", "=", 
       RowBox[{"SparseArray", "[", 
        RowBox[{"ArrayFlatten", "[", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"{", "m1", "}"}], ",", 
           RowBox[{"{", "m2", "}"}], ",", 
           RowBox[{"{", "m3", "}"}]}], "}"}], "]"}], "]"}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"b", "=", 
       RowBox[{"Join", "[", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{"ListQ", "@", "quotaU"}], ",", "quotaU", ",", 
           RowBox[{"Table", "[", 
            RowBox[{"quotaU", ",", 
             RowBox[{"{", "numU", "}"}]}], "]"}]}], "]"}], ",", 
         "\[IndentingNewLine]", 
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{"ListQ", "@", "quotaD"}], ",", "quotaD", ",", 
           RowBox[{"Table", "[", 
            RowBox[{"quotaD", ",", 
             RowBox[{"{", "numD", "}"}]}], "]"}]}], "]"}], ",", 
         "\[IndentingNewLine]", 
         RowBox[{"Table", "[", 
          RowBox[{"1", ",", 
           RowBox[{"{", 
            RowBox[{"numU", "*", "numD"}], "}"}]}], "]"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{"Remember", ":", 
         RowBox[{
         "linear", " ", "programming", " ", "will", " ", "minimize"}]}], ",", 
        RowBox[{
        "so", " ", "we", " ", "need", " ", "to", " ", "negate", " ", "the", 
         " ", "\"\<c\>\"", " ", 
         RowBox[{"vector", ".", "Similarly"}]}], ",", 
        RowBox[{
         RowBox[{
         "since", " ", "the", " ", "constraint", " ", "is", " ", "taken", " ",
           "to", " ", "be", " ", 
          RowBox[{"m", ".", "x"}]}], "\[GreaterEqual]", "b"}], ",", 
        RowBox[{
        "we", " ", "need", " ", "to", " ", "negate", " ", "m", " ", "and", 
         " ", "b", " ", "as", " ", 
         RowBox[{"well", "."}]}]}], "*)"}], "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"lpOptions", "\[NotEqual]", "Null"}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{"matchMatrix", "=", 
         RowBox[{"LinearProgramming", "[", 
          RowBox[{
           RowBox[{"-", 
            RowBox[{"Flatten", "[", "payoffs", "]"}]}], ",", 
           RowBox[{"-", "m"}], ",", 
           RowBox[{"-", "b"}], ",", "lpOptions", ",", "realorint"}], "]"}]}], 
        ",", "\[IndentingNewLine]", 
        RowBox[{"matchMatrix", "=", 
         RowBox[{"LinearProgramming", "[", 
          RowBox[{
           RowBox[{"-", 
            RowBox[{"Flatten", "[", "payoffs", "]"}]}], ",", 
           RowBox[{"-", "m"}], ",", 
           RowBox[{"-", "b"}], ",", "0", ",", "realorint"}], "]"}]}]}], "]"}],
       ";", "\[IndentingNewLine]", 
      RowBox[{"result", "=", 
       RowBox[{"Partition", "[", 
        RowBox[{"matchMatrix", ",", "numD"}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{"rationalize", ",", 
        RowBox[{"Map", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"Rationalize", "[", 
            RowBox[{"#", ",", ".01"}], "]"}], "&"}], ",", "result", ",", 
          RowBox[{"{", "2", "}"}]}], "]"}], ",", "result"}], "]"}]}]}], 
    "\[IndentingNewLine]", "]"}]}], ";"}]}], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.6116580777335625`*^9, 3.611658154281042*^9}, {
  3.6116581919628253`*^9, 3.61165826679718*^9}, {3.6116590577307205`*^9, 
  3.6116590805779696`*^9}, {3.611659119697054*^9, 3.611659120615999*^9}, {
  3.6116593314820538`*^9, 3.61165937656909*^9}, {3.611659480903691*^9, 
  3.611659578482917*^9}, {3.611659608930728*^9, 3.611659619544986*^9}, {
  3.6327387424390244`*^9, 3.632738769770079*^9}, {3.632738816189351*^9, 
  3.6327388352926674`*^9}, {3.642292975360422*^9, 3.642293080458453*^9}, {
  3.642293386011127*^9, 3.642293449637931*^9}, {3.642310160774971*^9, 
  3.642310175623087*^9}, {3.6970478390739317`*^9, 3.697047864768412*^9}},
 Background->RGBColor[0.88, 1, 0.88]],

Cell[CellGroupData[{

Cell["Unit testing", "Subsubsection",
 CellChangeTimes->{{3.642294105795484*^9, 3.6422941255956783`*^9}, {
  3.642294430670465*^9, 3.642294433638226*^9}, {3.642294476574922*^9, 
  3.642294477301858*^9}}],

Cell[BoxData[
 RowBox[{"ClearAll", "[", "\"\<TU*\>\"", "]"}]], "Input",
 CellChangeTimes->{{3.642294218365328*^9, 3.642294223744439*^9}, {
  3.6422942686184607`*^9, 3.6422943390309*^9}, {3.642295073410316*^9, 
  3.642295104993127*^9}, {3.642295338079138*^9, 3.642295338504883*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"TUnumNests", " ", "=", " ", "1"}], ";"}]], "Input",
 CellChangeTimes->{
  3.605410304515371*^9, 3.642294908606838*^9, {3.6422951114251337`*^9, 
   3.642295112151396*^9}, {3.642295235722637*^9, 3.642295248825018*^9}}],

Cell[BoxData[{
 RowBox[{
  RowBox[{"TUnumMatchesU", "=", "5"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"TUnumMatchesD", "=", "15"}], ";"}]}], "Input",
 CellChangeTimes->{{3.605410386167041*^9, 3.605410411203473*^9}, {
   3.6054105561227617`*^9, 3.6054105582358828`*^9}, {3.6054110321959915`*^9, 
   3.6054110325230103`*^9}, {3.6054112753478994`*^9, 
   3.6054112758749294`*^9}, {3.6054115910839586`*^9, 
   3.6054115939071198`*^9}, {3.6054116949659*^9, 3.605411697683056*^9}, 
   3.6054122937761497`*^9, {3.642294913615336*^9, 3.6422949154623747`*^9}, {
   3.642295114408959*^9, 3.6422951184956703`*^9}, {3.6422952418229322`*^9, 
   3.6422952537124853`*^9}}],

Cell[BoxData[{
 RowBox[{
  RowBox[{"TUx1m", "=", " ", 
   RowBox[{"Table", "[", 
    RowBox[{
     RowBox[{
      RowBox[{"4", "*", 
       RowBox[{"Random", "[", 
        RowBox[{"ChiDistribution", "[", "1.5", "]"}], "]"}]}], " ", "+", " ", 
      "9"}], ",", " ", 
     RowBox[{"{", 
      RowBox[{"h", ",", " ", "1", ",", "TUnumNests"}], "}"}], ",", " ", 
     RowBox[{"{", 
      RowBox[{"i", ",", " ", "1", ",", " ", "TUnumMatchesU"}], "}"}]}], 
    "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"TUx1f", " ", "=", " ", 
   RowBox[{"Table", "[", 
    RowBox[{
     RowBox[{
      RowBox[{"4", "*", 
       RowBox[{"Random", "[", 
        RowBox[{"ChiDistribution", "[", "2", "]"}], "]"}]}], "+", "9"}], ",", 
     " ", 
     RowBox[{"{", 
      RowBox[{"h", ",", "1", ",", "TUnumNests"}], "}"}], ",", " ", 
     RowBox[{"{", 
      RowBox[{"j", ",", " ", "1", ",", "TUnumMatchesD"}], "}"}]}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"TUx2m", " ", "=", " ", 
   RowBox[{"Table", "[", 
    RowBox[{
     RowBox[{"Random", "[", 
      RowBox[{"NormalDistribution", "[", 
       RowBox[{"10", ",", " ", "1"}], "]"}], "]"}], ",", 
     RowBox[{"{", 
      RowBox[{"h", ",", "1", ",", "TUnumNests"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"i", ",", "1", ",", "TUnumMatchesU"}], "}"}]}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"TUx2f", " ", "=", " ", 
   RowBox[{"Table", "[", 
    RowBox[{
     RowBox[{"Random", "[", 
      RowBox[{"NormalDistribution", "[", 
       RowBox[{"10", ",", "1"}], "]"}], "]"}], ",", " ", 
     RowBox[{"{", 
      RowBox[{"h", ",", "1", ",", "TUnumNests"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"j", ",", "1", ",", "TUnumMatchesD"}], "}"}]}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"TUx3m", " ", "=", " ", 
   RowBox[{"Table", "[", 
    RowBox[{
     RowBox[{"Random", "[", 
      RowBox[{"LogNormalDistribution", "[", 
       RowBox[{"1", ",", " ", ".5"}], "]"}], "]"}], ",", " ", 
     RowBox[{"{", 
      RowBox[{"h", ",", "1", ",", "TUnumNests"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"j", ",", "1", ",", "TUnumMatchesU"}], "}"}]}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"TUx3f", " ", "=", " ", 
   RowBox[{"Table", "[", 
    RowBox[{
     RowBox[{"Random", "[", 
      RowBox[{"LogNormalDistribution", "[", 
       RowBox[{"1", ",", " ", "1.5"}], "]"}], "]"}], ",", " ", 
     RowBox[{"{", 
      RowBox[{"h", ",", "1", ",", "TUnumNests"}], "}"}], ",", " ", 
     RowBox[{"{", 
      RowBox[{"j", ",", "1", ",", "TUnumMatchesD"}], "}"}]}], "]"}]}], 
  ";"}]}], "Input",
 CellChangeTimes->{
  3.605410425341282*^9, {3.6057524884753885`*^9, 3.6057525188391247`*^9}, 
   3.6057534025436697`*^9, {3.6422949197797203`*^9, 3.642294929954302*^9}, {
   3.642295021066193*^9, 3.642295038238151*^9}, {3.64229512331435*^9, 
   3.642295195047188*^9}, {3.642295257283011*^9, 3.642295324578657*^9}, {
   3.64229548318147*^9, 3.642295486247067*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"TUmatchPayoff", "[", 
   RowBox[{"n_", ",", "i_", ",", "j_", ",", "b1_", ",", "b2_"}], "]"}], ":=", 
  RowBox[{
   RowBox[{
    RowBox[{"TUx1m", "[", 
     RowBox[{"[", 
      RowBox[{"n", ",", "i"}], "]"}], "]"}], "*", 
    RowBox[{"TUx1f", "[", 
     RowBox[{"[", 
      RowBox[{"n", ",", "j"}], "]"}], "]"}]}], " ", "+", " ", 
   RowBox[{"b1", "*", 
    RowBox[{"TUx2m", "[", 
     RowBox[{"[", 
      RowBox[{"n", ",", "i"}], "]"}], "]"}], "*", 
    RowBox[{"TUx2f", "[", 
     RowBox[{"[", 
      RowBox[{"n", ",", "j"}], "]"}], "]"}]}], " ", "+", " ", 
   RowBox[{"b2", "*", 
    RowBox[{"TUx3m", "[", 
     RowBox[{"[", 
      RowBox[{"n", ",", "i"}], "]"}], "]"}], "*", 
    RowBox[{"TUx3f", "[", 
     RowBox[{"[", 
      RowBox[{"n", ",", "j"}], "]"}], "]"}]}]}]}]], "Input",
 CellChangeTimes->{{3.642294932078219*^9, 3.642294943561193*^9}, {
  3.642295219309515*^9, 3.642295219543807*^9}, {3.642295349093055*^9, 
  3.642295368339279*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"TUpayoffMatrices", " ", "=", " ", 
   RowBox[{"Table", "[", 
    RowBox[{
     RowBox[{
      RowBox[{"TUmatchPayoff", "[", 
       RowBox[{"h", ",", " ", "i", ",", "j", ",", " ", "5", ",", " ", "3"}], 
       "]"}], " ", "+", " ", 
      RowBox[{"Random", "[", 
       RowBox[{"NormalDistribution", "[", 
        RowBox[{"0", ",", "1"}], "]"}], "]"}]}], ",", " ", 
     RowBox[{"{", 
      RowBox[{"h", ",", " ", "1", ",", " ", "TUnumNests"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"i", ",", " ", "1", ",", " ", "TUnumMatchesU"}], "}"}], ",", 
     " ", 
     RowBox[{"{", 
      RowBox[{"j", ",", " ", "1", ",", " ", "TUnumMatchesD"}], "}"}]}], 
    "]"}]}], ";"}]], "Input",
 CellChangeTimes->{{3.6054104858447423`*^9, 3.6054104894689493`*^9}, {
  3.642294945665576*^9, 3.642294966497395*^9}, {3.642295370941181*^9, 
  3.642295380546425*^9}}],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"Dimensions", "[", "TUpayoffMatrices", "]"}]], "Input",
 CellChangeTimes->{{3.60541049280214*^9, 3.605410499859544*^9}, 
   3.642294971392233*^9, 3.642295386146529*^9}],

Cell[BoxData[
 RowBox[{"{", 
  RowBox[{"1", ",", "5", ",", "15"}], "}"}]], "Output",
 CellChangeTimes->{
  3.6054105005835853`*^9, 3.605410564898264*^9, 3.605411038315342*^9, 
   3.6054112813172407`*^9, 3.605411602394605*^9, 3.605411703160369*^9, 
   3.6054123001455145`*^9, 3.6057534330134125`*^9, 3.6057724304418135`*^9, 
   3.605775139680773*^9, 3.605775367776819*^9, 3.6058378794005933`*^9, {
   3.606453374363126*^9, 3.606453384346697*^9}, 3.6064535616588387`*^9, 
   3.60709244133764*^9, 3.6070931607757893`*^9, 3.60709669700105*^9, 
   3.6422942481987123`*^9, 3.642294349540679*^9, 3.642294971985488*^9, 
   3.642295047156818*^9, 3.642295503302658*^9, 3.642295812178952*^9, 
   3.642295991926442*^9}]
}, Open  ]],

Cell[BoxData[
 RowBox[{
  RowBox[{"TUmatchMatrices", " ", "=", " ", 
   RowBox[{"Table", "[", 
    RowBox[{
     RowBox[{
      StyleBox["generateAssignmentMatrix",
       Background->RGBColor[1, 1, 0]], "[", 
      RowBox[{
       RowBox[{"TUpayoffMatrices", "[", 
        RowBox[{"[", "h", "]"}], "]"}], ",", "3", ",", "1"}], "]"}], ",", " ", 
     RowBox[{"{", 
      RowBox[{"h", ",", "1", ",", "TUnumNests"}], "}"}]}], "]"}]}], 
  ";"}]], "Input",
 CellChangeTimes->{{3.605410632700142*^9, 3.6054106394205265`*^9}, {
   3.6054107015250783`*^9, 3.6054107197961235`*^9}, 3.6054110218524*^9, {
   3.6054112029897604`*^9, 3.6054112216678286`*^9}, 3.60541157643112*^9, {
   3.6054116075408993`*^9, 3.605411607708909*^9}, {3.6054116434529533`*^9, 
   3.605411643619963*^9}, {3.605411681693141*^9, 3.605411682044161*^9}, 
   3.605411741444558*^9, 3.605412172737227*^9, {3.6054122823204947`*^9, 
   3.605412313256264*^9}, 3.60645337949742*^9, 3.6064535565685472`*^9, {
   3.642294973184353*^9, 3.642294980415756*^9}, {3.642295389003191*^9, 
   3.642295396891281*^9}}],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{
  RowBox[{"TUmatchMatrices", "[", 
   RowBox[{"[", "1", "]"}], "]"}], "//", "MatrixForm"}]], "Input",
 CellChangeTimes->{{3.6054105288662033`*^9, 3.6054105724756975`*^9}, {
   3.6057753562701607`*^9, 3.6057753891190395`*^9}, 3.642294984060108*^9, 
   3.642295399547504*^9}],

Cell[BoxData[
 TagBox[
  RowBox[{"(", "\[NoBreak]", GridBox[{
     {"0", "0", "0", "0", "0", "1", "0", "0", "0", "1", "1", "0", "0", "0", 
      "0"},
     {"1", "0", "0", "0", "1", "0", "0", "1", "0", "0", "0", "0", "0", "0", 
      "0"},
     {"0", "1", "0", "1", "0", "0", "0", "0", "0", "0", "0", "0", "0", "1", 
      "0"},
     {"0", "0", "1", "0", "0", "0", "0", "0", "1", "0", "0", "1", "0", "0", 
      "0"},
     {"0", "0", "0", "0", "0", "0", "1", "0", "0", "0", "0", "0", "1", "0", 
      "1"}
    },
    GridBoxAlignment->{
     "Columns" -> {{Center}}, "ColumnsIndexed" -> {}, "Rows" -> {{Baseline}}, 
      "RowsIndexed" -> {}},
    GridBoxSpacings->{"Columns" -> {
        Offset[0.27999999999999997`], {
         Offset[0.7]}, 
        Offset[0.27999999999999997`]}, "ColumnsIndexed" -> {}, "Rows" -> {
        Offset[0.2], {
         Offset[0.4]}, 
        Offset[0.2]}, "RowsIndexed" -> {}}], "\[NoBreak]", ")"}],
  Function[BoxForm`e$, 
   MatrixForm[BoxForm`e$]]]], "Output",
 CellChangeTimes->{{3.605410532220395*^9, 3.6054105727967157`*^9}, {
   3.605410634213228*^9, 3.605410640723601*^9}, {3.6054107053722982`*^9, 
   3.605410721362213*^9}, {3.6054110232244787`*^9, 3.6054110400424404`*^9}, {
   3.605411204360839*^9, 3.605411222931901*^9}, 3.6054112826503167`*^9, {
   3.6054115792742825`*^9, 3.6054116089369793`*^9}, 3.60541164741218*^9, {
   3.60541168307822*^9, 3.605411706311549*^9}, 3.605411743339667*^9, {
   3.605412155462239*^9, 3.6054121740853043`*^9}, {3.6054122833815556`*^9, 
   3.605412315263379*^9}, 3.6057534360835886`*^9, 3.605772431674884*^9, 
   3.605775139721775*^9, {3.605775369502918*^9, 3.605775389630069*^9}, 
   3.605837881208697*^9, {3.6064533744561315`*^9, 3.6064533843856993`*^9}, 
   3.606453561695841*^9, 3.607092443398758*^9, 3.607093160796791*^9, 
   3.6070966970230513`*^9, 3.642294262282794*^9, 3.6422943528855467`*^9, 
   3.642294984923685*^9, 3.642295048576661*^9, 3.642295503354072*^9, 
   3.642295812270731*^9, 3.642295991976677*^9}]
}, Open  ]],

Cell[BoxData[
 RowBox[{
  RowBox[{"TUmatchMatrices", " ", "=", " ", 
   RowBox[{"Table", "[", 
    RowBox[{
     RowBox[{
      StyleBox["generateAssignmentMatrix",
       Background->RGBColor[1, 1, 0]], "[", 
      RowBox[{
       RowBox[{"TUpayoffMatrices", "[", 
        RowBox[{"[", "h", "]"}], "]"}], ",", 
       RowBox[{"{", 
        RowBox[{"3", ",", "3", ",", "3", ",", "3", ",", "3"}], "}"}], ",", 
       "1"}], "]"}], ",", " ", 
     RowBox[{"{", 
      RowBox[{"h", ",", "1", ",", "TUnumNests"}], "}"}]}], "]"}]}], 
  ";"}]], "Input",
 CellChangeTimes->{{3.605410632700142*^9, 3.6054106394205265`*^9}, {
   3.6054107015250783`*^9, 3.6054107197961235`*^9}, 3.6054110218524*^9, {
   3.6054112029897604`*^9, 3.6054112216678286`*^9}, 3.60541157643112*^9, {
   3.6054116075408993`*^9, 3.605411607708909*^9}, {3.6054116434529533`*^9, 
   3.605411643619963*^9}, {3.605411681693141*^9, 3.605411682044161*^9}, 
   3.605411741444558*^9, 3.605412172737227*^9, {3.6054122823204947`*^9, 
   3.605412313256264*^9}, 3.60645337949742*^9, 3.6064535565685472`*^9, {
   3.642294375091053*^9, 3.642294406763351*^9}, {3.642294986947877*^9, 
   3.6422949942971354`*^9}, {3.642295402708186*^9, 3.642295410856958*^9}}],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{
  RowBox[{"TUmatchMatrices", "[", 
   RowBox[{"[", "1", "]"}], "]"}], "//", "MatrixForm"}]], "Input",
 CellChangeTimes->{{3.6054105288662033`*^9, 3.6054105724756975`*^9}, {
   3.6057753562701607`*^9, 3.6057753891190395`*^9}, 3.642294997856779*^9, 
   3.642295413867114*^9}],

Cell[BoxData[
 TagBox[
  RowBox[{"(", "\[NoBreak]", GridBox[{
     {"0", "0", "0", "0", "0", "1", "0", "0", "0", "1", "1", "0", "0", "0", 
      "0"},
     {"1", "0", "0", "0", "1", "0", "0", "1", "0", "0", "0", "0", "0", "0", 
      "0"},
     {"0", "1", "0", "1", "0", "0", "0", "0", "0", "0", "0", "0", "0", "1", 
      "0"},
     {"0", "0", "1", "0", "0", "0", "0", "0", "1", "0", "0", "1", "0", "0", 
      "0"},
     {"0", "0", "0", "0", "0", "0", "1", "0", "0", "0", "0", "0", "1", "0", 
      "1"}
    },
    GridBoxAlignment->{
     "Columns" -> {{Center}}, "ColumnsIndexed" -> {}, "Rows" -> {{Baseline}}, 
      "RowsIndexed" -> {}},
    GridBoxSpacings->{"Columns" -> {
        Offset[0.27999999999999997`], {
         Offset[0.7]}, 
        Offset[0.27999999999999997`]}, "ColumnsIndexed" -> {}, "Rows" -> {
        Offset[0.2], {
         Offset[0.4]}, 
        Offset[0.2]}, "RowsIndexed" -> {}}], "\[NoBreak]", ")"}],
  Function[BoxForm`e$, 
   MatrixForm[BoxForm`e$]]]], "Output",
 CellChangeTimes->{{3.605410532220395*^9, 3.6054105727967157`*^9}, {
   3.605410634213228*^9, 3.605410640723601*^9}, {3.6054107053722982`*^9, 
   3.605410721362213*^9}, {3.6054110232244787`*^9, 3.6054110400424404`*^9}, {
   3.605411204360839*^9, 3.605411222931901*^9}, 3.6054112826503167`*^9, {
   3.6054115792742825`*^9, 3.6054116089369793`*^9}, 3.60541164741218*^9, {
   3.60541168307822*^9, 3.605411706311549*^9}, 3.605411743339667*^9, {
   3.605412155462239*^9, 3.6054121740853043`*^9}, {3.6054122833815556`*^9, 
   3.605412315263379*^9}, 3.6057534360835886`*^9, 3.605772431674884*^9, 
   3.605775139721775*^9, {3.605775369502918*^9, 3.605775389630069*^9}, 
   3.605837881208697*^9, {3.6064533744561315`*^9, 3.6064533843856993`*^9}, 
   3.606453561695841*^9, 3.607092443398758*^9, 3.607093160796791*^9, 
   3.6070966970230513`*^9, 3.642294262282794*^9, 3.6422943528855467`*^9, {
   3.642294387957086*^9, 3.642294408749008*^9}, 3.642294998599391*^9, 
   3.6422950499561462`*^9, 3.642295503401086*^9, 3.642295812357624*^9, 
   3.6422959920480947`*^9}]
}, Open  ]],

Cell[BoxData[
 RowBox[{
  RowBox[{"TUmatchMatrices", " ", "=", " ", 
   RowBox[{"Table", "[", 
    RowBox[{
     RowBox[{
      StyleBox["generateAssignmentMatrix",
       Background->RGBColor[1, 1, 0]], "[", 
      RowBox[{
       RowBox[{"TUpayoffMatrices", "[", 
        RowBox[{"[", "h", "]"}], "]"}], ",", 
       RowBox[{"{", 
        RowBox[{"3", ",", "1", ",", "3", ",", "0", ",", "2"}], "}"}], ",", 
       "1"}], "]"}], ",", " ", 
     RowBox[{"{", 
      RowBox[{"h", ",", "1", ",", "TUnumNests"}], "}"}]}], "]"}]}], 
  ";"}]], "Input",
 CellChangeTimes->{{3.605410632700142*^9, 3.6054106394205265`*^9}, {
   3.6054107015250783`*^9, 3.6054107197961235`*^9}, 3.6054110218524*^9, {
   3.6054112029897604`*^9, 3.6054112216678286`*^9}, 3.60541157643112*^9, {
   3.6054116075408993`*^9, 3.605411607708909*^9}, {3.6054116434529533`*^9, 
   3.605411643619963*^9}, {3.605411681693141*^9, 3.605411682044161*^9}, 
   3.605411741444558*^9, 3.605412172737227*^9, {3.6054122823204947`*^9, 
   3.605412313256264*^9}, 3.60645337949742*^9, 3.6064535565685472`*^9, {
   3.642294375091053*^9, 3.642294406763351*^9}, {3.642294499876985*^9, 
   3.642294514148917*^9}, {3.6422950018089037`*^9, 3.642295006879889*^9}, {
   3.642295416828452*^9, 3.6422954248350983`*^9}}],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{
  RowBox[{"TUmatchMatrices", "[", 
   RowBox[{"[", "1", "]"}], "]"}], "//", "MatrixForm"}]], "Input",
 CellChangeTimes->{{3.6054105288662033`*^9, 3.6054105724756975`*^9}, {
   3.6057753562701607`*^9, 3.6057753891190395`*^9}, 3.6422950091801357`*^9, 
   3.642295428602992*^9}],

Cell[BoxData[
 TagBox[
  RowBox[{"(", "\[NoBreak]", GridBox[{
     {"0", "0", "1", "0", "0", "1", "0", "0", "0", "1", "0", "0", "0", "0", 
      "0"},
     {"0", "0", "0", "0", "1", "0", "0", "0", "0", "0", "0", "0", "0", "0", 
      "0"},
     {"1", "0", "0", "0", "0", "0", "0", "1", "0", "0", "0", "0", "0", "1", 
      "0"},
     {"0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", 
      "0"},
     {"0", "0", "0", "0", "0", "0", "1", "0", "1", "0", "0", "0", "0", "0", 
      "0"}
    },
    GridBoxAlignment->{
     "Columns" -> {{Center}}, "ColumnsIndexed" -> {}, "Rows" -> {{Baseline}}, 
      "RowsIndexed" -> {}},
    GridBoxSpacings->{"Columns" -> {
        Offset[0.27999999999999997`], {
         Offset[0.7]}, 
        Offset[0.27999999999999997`]}, "ColumnsIndexed" -> {}, "Rows" -> {
        Offset[0.2], {
         Offset[0.4]}, 
        Offset[0.2]}, "RowsIndexed" -> {}}], "\[NoBreak]", ")"}],
  Function[BoxForm`e$, 
   MatrixForm[BoxForm`e$]]]], "Output",
 CellChangeTimes->{{3.605410532220395*^9, 3.6054105727967157`*^9}, {
   3.605410634213228*^9, 3.605410640723601*^9}, {3.6054107053722982`*^9, 
   3.605410721362213*^9}, {3.6054110232244787`*^9, 3.6054110400424404`*^9}, {
   3.605411204360839*^9, 3.605411222931901*^9}, 3.6054112826503167`*^9, {
   3.6054115792742825`*^9, 3.6054116089369793`*^9}, 3.60541164741218*^9, {
   3.60541168307822*^9, 3.605411706311549*^9}, 3.605411743339667*^9, {
   3.605412155462239*^9, 3.6054121740853043`*^9}, {3.6054122833815556`*^9, 
   3.605412315263379*^9}, 3.6057534360835886`*^9, 3.605772431674884*^9, 
   3.605775139721775*^9, {3.605775369502918*^9, 3.605775389630069*^9}, 
   3.605837881208697*^9, {3.6064533744561315`*^9, 3.6064533843856993`*^9}, 
   3.606453561695841*^9, 3.607092443398758*^9, 3.607093160796791*^9, 
   3.6070966970230513`*^9, 3.642294262282794*^9, 3.6422943528855467`*^9, {
   3.642294387957086*^9, 3.642294408749008*^9}, {3.642294502594481*^9, 
   3.642294515959733*^9}, 3.642295010162237*^9, 3.642295054937532*^9, 
   3.6422955034562407`*^9, 3.642295812406707*^9, 3.642295992110311*^9}]
}, Open  ]],

Cell[BoxData[
 RowBox[{
  RowBox[{"TUmatchMatrices", " ", "=", " ", 
   RowBox[{"Table", "[", 
    RowBox[{
     RowBox[{
      StyleBox["generateAssignmentMatrix",
       Background->RGBColor[1, 1, 0]], "[", 
      RowBox[{
       RowBox[{"TUpayoffMatrices", "[", 
        RowBox[{"[", "h", "]"}], "]"}], ",", 
       RowBox[{"{", 
        RowBox[{"3", ",", "1", ",", "3", ",", "0", ",", "2"}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{
        "1", ",", "0", ",", "2", ",", "2", ",", "1", ",", "1", ",", "1", ",", 
         "1", ",", "1", ",", "1", ",", "1", ",", "1", ",", "1", ",", "1", ",",
          "0"}], "}"}]}], "]"}], ",", " ", 
     RowBox[{"{", 
      RowBox[{"h", ",", "1", ",", "TUnumNests"}], "}"}]}], "]"}]}], 
  ";"}]], "Input",
 CellChangeTimes->{{3.605410632700142*^9, 3.6054106394205265`*^9}, {
   3.6054107015250783`*^9, 3.6054107197961235`*^9}, 3.6054110218524*^9, {
   3.6054112029897604`*^9, 3.6054112216678286`*^9}, 3.60541157643112*^9, {
   3.6054116075408993`*^9, 3.605411607708909*^9}, {3.6054116434529533`*^9, 
   3.605411643619963*^9}, {3.605411681693141*^9, 3.605411682044161*^9}, 
   3.605411741444558*^9, 3.605412172737227*^9, {3.6054122823204947`*^9, 
   3.605412313256264*^9}, 3.60645337949742*^9, 3.6064535565685472`*^9, {
   3.642294375091053*^9, 3.642294406763351*^9}, {3.642294499876985*^9, 
   3.642294514148917*^9}, {3.6422950018089037`*^9, 3.642295006879889*^9}, {
   3.642295416828452*^9, 3.6422954248350983`*^9}, {3.642295937268672*^9, 
   3.642295950680901*^9}}],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{
  RowBox[{"TUmatchMatrices", "[", 
   RowBox[{"[", "1", "]"}], "]"}], "//", "MatrixForm"}]], "Input",
 CellChangeTimes->{{3.6054105288662033`*^9, 3.6054105724756975`*^9}, {
   3.6057753562701607`*^9, 3.6057753891190395`*^9}, 3.6422950091801357`*^9, 
   3.642295428602992*^9}],

Cell[BoxData[
 TagBox[
  RowBox[{"(", "\[NoBreak]", GridBox[{
     {"0", "0", "1", "0", "0", "1", "0", "0", "0", "1", "0", "0", "0", "0", 
      "0"},
     {"0", "0", "0", "0", "1", "0", "0", "0", "0", "0", "0", "0", "0", "0", 
      "0"},
     {"1", "0", "0", "0", "0", "0", "0", "1", "0", "0", "0", "0", "0", "1", 
      "0"},
     {"0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", "0", 
      "0"},
     {"0", "0", "1", "0", "0", "0", "1", "0", "0", "0", "0", "0", "0", "0", 
      "0"}
    },
    GridBoxAlignment->{
     "Columns" -> {{Center}}, "ColumnsIndexed" -> {}, "Rows" -> {{Baseline}}, 
      "RowsIndexed" -> {}},
    GridBoxSpacings->{"Columns" -> {
        Offset[0.27999999999999997`], {
         Offset[0.7]}, 
        Offset[0.27999999999999997`]}, "ColumnsIndexed" -> {}, "Rows" -> {
        Offset[0.2], {
         Offset[0.4]}, 
        Offset[0.2]}, "RowsIndexed" -> {}}], "\[NoBreak]", ")"}],
  Function[BoxForm`e$, 
   MatrixForm[BoxForm`e$]]]], "Output",
 CellChangeTimes->{{3.605410532220395*^9, 3.6054105727967157`*^9}, {
   3.605410634213228*^9, 3.605410640723601*^9}, {3.6054107053722982`*^9, 
   3.605410721362213*^9}, {3.6054110232244787`*^9, 3.6054110400424404`*^9}, {
   3.605411204360839*^9, 3.605411222931901*^9}, 3.6054112826503167`*^9, {
   3.6054115792742825`*^9, 3.6054116089369793`*^9}, 3.60541164741218*^9, {
   3.60541168307822*^9, 3.605411706311549*^9}, 3.605411743339667*^9, {
   3.605412155462239*^9, 3.6054121740853043`*^9}, {3.6054122833815556`*^9, 
   3.605412315263379*^9}, 3.6057534360835886`*^9, 3.605772431674884*^9, 
   3.605775139721775*^9, {3.605775369502918*^9, 3.605775389630069*^9}, 
   3.605837881208697*^9, {3.6064533744561315`*^9, 3.6064533843856993`*^9}, 
   3.606453561695841*^9, 3.607092443398758*^9, 3.607093160796791*^9, 
   3.6070966970230513`*^9, 3.642294262282794*^9, 3.6422943528855467`*^9, {
   3.642294387957086*^9, 3.642294408749008*^9}, {3.642294502594481*^9, 
   3.642294515959733*^9}, 3.642295010162237*^9, 3.642295054937532*^9, 
   3.6422955034562407`*^9, 3.642295812406707*^9, 3.642295992213331*^9}]
}, Open  ]]
}, Closed]]
}, Open  ]],

Cell[CellGroupData[{

Cell["matchMatrix=CmatchMatrix[payoffMatrix,quotaU,quotaD]", "Subsection",
 CellChangeTimes->{{3.6263308968647165`*^9, 3.6263309292397165`*^9}}],

Cell["Obviously we must calculate the payoffMatrix first!", "Text",
 CellChangeTimes->{{3.6263309331615915`*^9, 3.6263309641303415`*^9}, 
   3.6263310299584665`*^9}],

Cell[BoxData[{
 RowBox[{
  RowBox[{"ClearAll", "[", "CmatchMatrix", "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"CmatchMatrix", "::", "usage"}], "=", 
  "\"\<CmatchMatrix[payoffMatrix_,quotaU_:1,quotaD_:1,p_:False]  \nCalculates \
and creates/updates the global variable 'matchMatrix'.\nIf p is set to \
'False', it creates the matchMatrix by running the generateAssignmentMatrix \
routine for all markets.\nIf p is set to 'True' , it does the same, only in \
parallel! ATTN: IT DOES NOT WORK WITH VARIABLE QUOTAS YET.\nIf p is set to an \
integer from 1 to the 'number of Markets' then the p'th element of the \
matchMatrix is calculated.\>\""}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"CmatchMatrix", "[", 
   RowBox[{"payoffMatrix_", ",", 
    RowBox[{"quotaU_:", "1"}], ",", 
    RowBox[{"quotaD_:", "1"}], ",", 
    RowBox[{"p_:", "False"}]}], "]"}], ":=", "\[IndentingNewLine]", 
  RowBox[{"If", "[", 
   RowBox[{
    RowBox[{"IntegerQ", "@", "p"}], ",", "\[IndentingNewLine]", 
    RowBox[{"If", "[", 
     RowBox[{
      RowBox[{"1", "\[LessEqual]", " ", "p", "\[LessEqual]", 
       RowBox[{"Length", "@", "payoffMatrix"}]}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"Definition", "@", "matchMatrix"}], "\[Equal]", "Null"}], 
         ",", 
         RowBox[{"matchMatrix", "=", 
          RowBox[{"Table", "[", 
           RowBox[{"Null", ",", 
            RowBox[{"{", 
             RowBox[{"Length", "@", "payoffMatrix"}], "}"}]}], "]"}]}]}], 
        "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"matchMatrix", "[", 
         RowBox[{"[", "p", "]"}], "]"}], "=", "\[IndentingNewLine]", 
        RowBox[{"generateAssignmentMatrix", "[", 
         RowBox[{
          RowBox[{"payoffMatrix", "[", 
           RowBox[{"[", "p", "]"}], "]"}], ",", "\[IndentingNewLine]", 
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{"ListQ", "@", "quotaU"}], ",", 
            RowBox[{"quotaU", "[", 
             RowBox[{"[", "p", "]"}], "]"}], ",", "quotaU"}], "]"}], ",", 
          "\[IndentingNewLine]", 
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{"ListQ", "@", "quotaD"}], ",", 
            RowBox[{"quotaD", "[", 
             RowBox[{"[", "p", "]"}], "]"}], ",", "quotaD"}], "]"}]}], 
         "\[IndentingNewLine]", "]"}]}], ";", "matchMatrix"}], 
      "\[IndentingNewLine]", ",", "\[IndentingNewLine]", 
      RowBox[{"Print", "[", "\"\<Invalid market index!\>\"", "]"}]}], 
     "\[IndentingNewLine]", "]"}], "\[IndentingNewLine]", ",", 
    "\[IndentingNewLine]", 
    RowBox[{"matchMatrix", "=", "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"p", "\[Equal]", "False"}], ",", "\[IndentingNewLine]", 
       RowBox[{"MapIndexed", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"generateAssignmentMatrix", "[", 
           RowBox[{"#1", ",", "\[IndentingNewLine]", 
            RowBox[{"If", "[", 
             RowBox[{
              RowBox[{"ListQ", "@", "quotaU"}], ",", 
              RowBox[{"quotaU", "[", 
               RowBox[{"[", 
                RowBox[{"First", "[", "#2", "]"}], "]"}], "]"}], ",", 
              "quotaU"}], "]"}], ",", "\[IndentingNewLine]", 
            RowBox[{"If", "[", 
             RowBox[{
              RowBox[{"ListQ", "@", "quotaD"}], ",", 
              RowBox[{"quotaD", "[", 
               RowBox[{"[", 
                RowBox[{"First", "[", "#2", "]"}], "]"}], "]"}], ",", 
              "quotaD"}], "]"}]}], "\[IndentingNewLine]", "]"}], "&"}], ",", 
         "payoffMatrix"}], "]"}], ",", "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{
         RowBox[{
          RowBox[{
           RowBox[{"generateAssignmentMatrix", "[", 
            RowBox[{"#", ",", "quotaU", ",", "quotaD"}], "]"}], "&"}], "/@", 
          "payoffMatrix"}], ","}], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"ParallelMap", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"generateAssignmentMatrix", "[", 
           RowBox[{"#", ",", "quotaU", ",", "quotaD"}], "]"}], "&"}], ",", 
         "payoffMatrix"}], "]"}]}], 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{
        "NOT", " ", "WORKING", " ", "WITH", " ", "VARIABLE", " ", "QUOTAS"}], 
        " ", "-", " ", "yet"}], "*)"}], "\[IndentingNewLine]", "]"}]}]}], 
   "\[IndentingNewLine]", "]"}]}]}], "Input",
 InitializationCell->True,
 CellChangeTimes->CompressedData["
1:eJxTTMoPSmViYGBQAWIQfWi1zpk1LK8dD2lfuwGmV995BqFF3kHE5c3Wgul7
5hB6oQOYXj3FCUQXdbmzPxN47bhBVEEORMdVVtqB6AXbjoHpx9v5PEC0DVOh
P4ju5mQPlFd+7Siu9S4IRDNumuWsBqSL3nq4gmj7sDlrQPS1nTfWguieiru7
QbRFQ8I+EN2UK75LoOq148k1S/aAaCMpvq8g+uveZf9BdNxUVw5BIP2rIRhM
G1Ve5QHR32RdpEB0/Xk3eRDN97JeGUQvKn5rBaLfZFRFgekvH+JB9Nc0uUwQ
3SkRVQCily9UKQTRUaW+TSBatKClGUQfZHjTAaLTZph0geg5f0I2gOgVJ+LA
9KyvHXtA9MeJ+w6AaLlZrUfA5vT+Pgqikx/8OgmihRbMPQWiuc27L4HoY+L8
N0B0QErVfRCt0Kj9EUSLnZkeKwSkzzmeAdN7LLcngWguHYYUEO2zKWIiiN70
kn8aiA5yE5YUBfHZssG0h8oCDRBdfqpdF0QfbZphDqJfLTO1ANGeE3esVQXS
/9b8XAeiFZ/r/1YD0gKKyX9AtAHrJYv+bqD9AhesQTQAMrINug==
  "],
 Background->RGBColor[0.88, 1, 0.88]],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"?", "CmatchMatrix"}]], "Input",
 CellChangeTimes->{{3.687878152264941*^9, 3.687878155003717*^9}}],

Cell[BoxData[
 StyleBox["\<\"CmatchMatrix[payoffMatrix_,quotaU_:1,quotaD_:1,p_:False] \
calculates and creates/updates the global variable 'matchMatrix'.\\nif p is \
set to 'False' creates the matchMatrix by running generateAssignmentMatrix \
routine for all markets.\\nif p is set to 'True' does the same only in \
parallel! NOT WORKING WITH VARIABLE QUOTAS - yet.\\nif p is set to an integer \
from 1 to 'number of Markets' then the p'th element of the matchMatrix is \
calculated.\"\>", "MSG"]], "Print", "PrintUsage",
 CellChangeTimes->{3.687931203909338*^9},
 CellTags->"Info43687938403-3708083"]
}, Open  ]],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"?", "MapIndexed"}]], "Input",
 CellChangeTimes->{{3.6879230567301083`*^9, 3.687923061164179*^9}}],

Cell[BoxData[
 RowBox[{
  StyleBox["\<\"\\!\\(\\*RowBox[{\\\"MapIndexed\\\", \\\"[\\\", \
RowBox[{StyleBox[\\\"f\\\", \\\"TI\\\"], \\\",\\\", StyleBox[\\\"expr\\\", \\\
\"TI\\\"]}], \\\"]\\\"}]\\) applies \\!\\(\\*StyleBox[\\\"f\\\", \
\\\"TI\\\"]\\) to the elements of \\!\\(\\*StyleBox[\\\"expr\\\", \\\"TI\\\"]\
\\), giving the part specification of each element as a second argument to \
\\!\\(\\*StyleBox[\\\"f\\\", \\\"TI\\\"]\\). \
\\n\\!\\(\\*RowBox[{\\\"MapIndexed\\\", \\\"[\\\", \
RowBox[{StyleBox[\\\"f\\\", \\\"TI\\\"], \\\",\\\", StyleBox[\\\"expr\\\", \\\
\"TI\\\"], \\\",\\\", StyleBox[\\\"levelspec\\\", \\\"TI\\\"]}], \
\\\"]\\\"}]\\) applies \\!\\(\\*StyleBox[\\\"f\\\", \\\"TI\\\"]\\) to all \
parts of \\!\\(\\*StyleBox[\\\"expr\\\", \\\"TI\\\"]\\) on levels specified \
by \\!\\(\\*StyleBox[\\\"levelspec\\\", \\\"TI\\\"]\\). \
\\n\\!\\(\\*RowBox[{\\\"MapIndexed\\\", \\\"[\\\", StyleBox[\\\"f\\\", \\\"TI\
\\\"], \\\"]\\\"}]\\) represents an operator form of MapIndexed that can be \
applied to an expression.\"\>", "MSG"], "\[NonBreakingSpace]", 
  ButtonBox[
   StyleBox["\[RightSkeleton]", "SR"],
   Active->True,
   BaseStyle->"Link",
   ButtonData->"paclet:ref/MapIndexed"]}]], "Print", "PrintUsage",
 CellChangeTimes->{3.68792306190816*^9},
 CellTags->"Info723687930261-4066488"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Unit testing", "Subsubsection",
 CellChangeTimes->{{3.642310216818613*^9, 3.64231021959524*^9}}],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"directory", "=", 
  RowBox[{"NotebookDirectory", "[", "]"}]}]], "Input",
 CellChangeTimes->{{3.6369625741502457`*^9, 3.636962600654554*^9}, 
   3.636962650795623*^9, 3.6369626892682133`*^9, {3.6423103614323263`*^9, 
   3.642310362527133*^9}, {3.642310571679482*^9, 3.64231058932232*^9}, 
   3.642310642104238*^9}],

Cell[BoxData["\<\"/home/tchr/Dropbox/Denisa_Mathematica-MSE/library/\"\>"], \
"Output",
 CellChangeTimes->{
  3.636962651174423*^9, 3.636962691969932*^9, 3.6369639605988894`*^9, 
   3.636970790974526*^9, 3.6369712290984173`*^9, 3.6385983830553455`*^9, 
   3.6422988416568823`*^9, 3.6422988945146523`*^9, 3.642310208787644*^9, {
   3.642310519787836*^9, 3.6423105400752163`*^9}, {3.642310573540146*^9, 
   3.642310620443858*^9}, {3.6423106713191137`*^9, 3.642310699742436*^9}, 
   3.6423108767002897`*^9, 3.642311061694797*^9, 3.642311223235867*^9, 
   3.6878776246057777`*^9, 3.6878776813191977`*^9, 3.687877719508357*^9, 
   3.6878777946909*^9, 3.687878582803176*^9, 3.687884927295385*^9, 
   3.687925789580884*^9}]
}, Open  ]],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"Get", "[", 
  RowBox[{"\"\<mse.m\>\"", ",", 
   RowBox[{"Path", "\[Rule]", "directory"}]}], "]"}]], "Input",
 CellChangeTimes->{{3.6303091438379374`*^9, 3.6303091800723124`*^9}, 
   3.6303092721035624`*^9, {3.642310367373456*^9, 3.642310367870948*^9}, {
   3.642310576283866*^9, 3.642310594648158*^9}, 3.642310676876841*^9}],

Cell[BoxData[
 RowBox[{"{", 
  RowBox[{"157369264", ",", "127706576", ",", "1"}], "}"}]], "Output",
 CellChangeTimes->{
  3.6305770055258126`*^9, 3.6305772673468037`*^9, 3.630582335665759*^9, 
   3.6305834061494207`*^9, 3.630583906116443*^9, 3.6305843465826235`*^9, 
   3.6305845633013735`*^9, 3.6305848948013735`*^9, 3.630586651074811*^9, 
   3.630586784777936*^9, 3.630590320467389*^9, 3.630590471654889*^9, 
   3.630591358451764*^9, 3.630592818764264*^9, {3.630592936670514*^9, 
   3.630592964217389*^9}, 3.630595132545514*^9, 3.630595243936139*^9, 
   3.630595628295514*^9, 3.6305978411558657`*^9, 3.630599442272568*^9, 
   3.630612258359473*^9, 3.630671763991976*^9, 3.6306744008009043`*^9, 
   3.630725069310239*^9, 3.6307276209078417`*^9, 3.6307277743368106`*^9, 
   3.6307278183917274`*^9, 3.6307434152694626`*^9, 3.6307444819866962`*^9, 
   3.630744556708056*^9, {3.6307473665954723`*^9, 3.630747374724143*^9}, 
   3.6307511730713773`*^9, 3.6307542944695225`*^9, 3.630754835660693*^9, 
   3.6307556841551332`*^9, 3.6307650704149313`*^9, 3.6307651156649313`*^9, 
   3.6307656563680563`*^9, 3.6307677783993063`*^9, 3.63076889099656*^9, 
   3.630770585848946*^9, 3.6307745487334375`*^9, 3.6309364193399267`*^9, 
   3.6309394034268007`*^9, 3.630940866111972*^9, 3.630941899304834*^9, 
   3.6309420995623007`*^9, 3.630948869497966*^9, 3.630956482109168*^9, 
   3.6309567939625196`*^9, 3.6311699615566916`*^9, 3.6311705482754416`*^9, 
   3.6311707685566916`*^9, 3.631174956777395*^9, 3.6311803584805193`*^9, 
   3.631187095421926*^9, 3.6311926649540997`*^9, 3.6311946574795623`*^9, 
   3.6311949322450075`*^9, 3.6311951020984774`*^9, 3.631195706189581*^9, 
   3.632931685388751*^9, 3.6337014794318237`*^9, 3.6337017737205887`*^9, 
   3.6337022130852284`*^9, 3.636962552124161*^9, 3.6369626038675003`*^9, 
   3.636962694419063*^9, 3.636963970806754*^9, 3.636970797636963*^9, 
   3.636971239638914*^9, 3.6385983872584705`*^9, 3.6422988435433187`*^9, 
   3.64229889694057*^9, 3.642310210210979*^9, {3.642310520195928*^9, 
   3.642310541881769*^9}, {3.642310577309627*^9, 3.6423106365207577`*^9}, {
   3.642310671513424*^9, 3.642310700032502*^9}, 3.6423108770993633`*^9, 
   3.64231106256977*^9, 3.642311223636424*^9, 3.687877628107642*^9, 
   3.687877682659486*^9, 3.687877721307852*^9, 3.687877796412266*^9, 
   3.68787858429593*^9, 3.687884930043416*^9, 3.6879257917287283`*^9}]
}, Open  ]],

Cell[BoxData[
 RowBox[{"ClearAll", "[", "\"\<TU*\>\"", "]"}]], "Input",
 CellChangeTimes->{{3.642310376272935*^9, 3.642310388066584*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"{", 
    RowBox[{"TUheader", ",", "TUnoM", ",", "TUnoU", ",", "TUnoD", ",", 
     StyleBox["noAttr",
      Background->RGBColor[1, 0.5, 0.5]], ",", 
     StyleBox["distanceMatrices",
      Background->RGBColor[1, 0.5, 0.5]], ",", "TUmatchMatrix", ",", 
     "TUmate"}], "}"}], "=", 
   RowBox[{"import", "[", 
    RowBox[{
     RowBox[{
      RowBox[{"NotebookDirectory", "[", "]"}], "<>", "\"\</import/\>\"", 
      "<>", "\"\<precomp_testdata.dat\>\""}], ",", "\"\<precomp\>\""}], 
    "]"}]}], ";"}]], "Input",
 CellChangeTimes->{{3.626171011874079*^9, 3.626171023855977*^9}, {
  3.642310312437974*^9, 3.642310338682663*^9}, {3.6423109125915403`*^9, 
  3.6423109370743303`*^9}, {3.6423110506247377`*^9, 3.642311058372011*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"TUpayoffMatrix", "=", 
   RowBox[{"CpayoffMatrix", "[", 
    RowBox[{"payoffDM", ",", "TUnoM", ",", "TUnoU", ",", "TUnoD"}], "]"}]}], 
  ";"}]], "Input",
 CellChangeTimes->{
  3.6261710966927123`*^9, {3.6261716047920165`*^9, 3.6261716104789906`*^9}, 
   3.626172860525609*^9, 3.626173494133915*^9, {3.6263319744115915`*^9, 
   3.6263319766615915`*^9}, {3.642310395147726*^9, 3.642310411264344*^9}, 
   3.642310711834962*^9}],

Cell["\<\
\[LineSeparator]Setting real values for x\[CloseCurlyQuote]s (Only then the \
matchMatrix can be calculated - it is a numerical computation - not symbolic)\
\>", "Text",
 CellChangeTimes->{{3.6263319895834665`*^9, 3.6263320654428415`*^9}, 
   3.687877634740879*^9}],

Cell[BoxData[
 RowBox[{
  RowBox[{"TUpayoffMatrix", "=", 
   RowBox[{"TUpayoffMatrix", "/.", 
    RowBox[{"Thread", "[", 
     RowBox[{
      RowBox[{"Cx", "[", "4", "]"}], "\[Rule]", 
      RowBox[{"{", 
       RowBox[{"1", ",", "2", ",", "1.5", ",", "2.3"}], "}"}]}], "]"}]}]}], 
  ";"}]], "Input",
 CellChangeTimes->{{3.626171121982574*^9, 3.626171168978284*^9}, 
   3.6261713989239902`*^9, 3.6261716277635903`*^9, {3.642310418342949*^9, 
   3.6423104238894033`*^9}}],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"TUmatchMatrix", "=", 
  RowBox[{
   StyleBox["CmatchMatrix",
    Background->RGBColor[1, 1, 0]], "[", 
   RowBox[{"TUpayoffMatrix", ",", "2", ",", "1"}], "]"}]}]], "Input",
 CellChangeTimes->{{3.626171261461618*^9, 3.626171265327815*^9}, {
   3.6263298485678415`*^9, 3.6263299028647165`*^9}, 3.6263320729272165`*^9, {
   3.6423076035037193`*^9, 3.642307613811006*^9}, {3.642310429302258*^9, 
   3.642310434193273*^9}, {3.642310715130673*^9, 3.642310715608391*^9}}],

Cell[BoxData[
 RowBox[{"{", 
  RowBox[{
   RowBox[{"{", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", 
       "0", ",", "1", ",", "0"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
      "0", ",", "0", ",", "0", ",", "1", ",", "0", ",", "1", ",", "0", ",", 
       "0", ",", "0", ",", "0"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
      "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", 
       "0", ",", "0", ",", "0"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
      "0", ",", "0", ",", "0", ",", "0", ",", "1", ",", "0", ",", "0", ",", 
       "0", ",", "0", ",", "0"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
      "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", 
       "0", ",", "0", ",", "0"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
      "0", ",", "0", ",", "1", ",", "0", ",", "0", ",", "0", ",", "0", ",", 
       "0", ",", "0", ",", "0"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
      "1", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "1", ",", 
       "0", ",", "0", ",", "0"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
      "0", ",", "1", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", 
       "0", ",", "0", ",", "0"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
      "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", 
       "0", ",", "0", ",", "1"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
      "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", 
       "1", ",", "0", ",", "0"}], "}"}]}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "0", ",", "0", ",", "0", ",", "0", ",", "1", ",", "0", ",", "0", ",", 
       "0", ",", "1", ",", "0"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
      "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "1", ",", 
       "0", ",", "0", ",", "0"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
      "0", ",", "0", ",", "0", ",", "1", ",", "0", ",", "0", ",", "0", ",", 
       "0", ",", "0", ",", "1"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
      "0", ",", "1", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", 
       "0", ",", "0", ",", "0"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
      "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", 
       "0", ",", "0", ",", "0"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
      "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", 
       "0", ",", "0", ",", "0"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
      "1", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", 
       "0", ",", "0", ",", "0"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
      "0", ",", "0", ",", "1", ",", "0", ",", "0", ",", "0", ",", "0", ",", 
       "0", ",", "0", ",", "0"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
      "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", 
       "0", ",", "0", ",", "0"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
      "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "1", ",", "0", ",", 
       "1", ",", "0", ",", "0"}], "}"}]}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "1", ",", 
       "0", ",", "0", ",", "0"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
      "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", 
       "0", ",", "0", ",", "0"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
      "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", 
       "0", ",", "1", ",", "0"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
      "1", ",", "1", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", 
       "0", ",", "0", ",", "0"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
      "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", 
       "0", ",", "0", ",", "0"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
      "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", 
       "0", ",", "0", ",", "0"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
      "0", ",", "0", ",", "0", ",", "0", ",", "1", ",", "1", ",", "0", ",", 
       "0", ",", "0", ",", "0"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
      "0", ",", "0", ",", "1", ",", "0", ",", "0", ",", "0", ",", "0", ",", 
       "1", ",", "0", ",", "0"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
      "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", 
       "0", ",", "0", ",", "0"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
      "0", ",", "0", ",", "0", ",", "1", ",", "0", ",", "0", ",", "0", ",", 
       "0", ",", "0", ",", "1"}], "}"}]}], "}"}]}], "}"}]], "Output",
 CellChangeTimes->{
  3.6423105203584023`*^9, {3.64231067171667*^9, 3.64231070025386*^9}, 
   3.642310878443864*^9, 3.642311069235189*^9, 3.642311223831292*^9, 
   3.6878776410049343`*^9, 3.68787772921108*^9, 3.687877805163247*^9, 
   3.687878593864867*^9, 3.6879258437108593`*^9}]
}, Open  ]],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"TUmatchMatrix2", "=", 
  RowBox[{
   StyleBox["CmatchMatrix",
    Background->RGBColor[1, 1, 0]], "[", 
   RowBox[{"TUpayoffMatrix", ",", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "2", ",", "2", ",", "2", ",", "2", ",", "2", ",", "2", ",", "2", ",", 
        "2", ",", "2", ",", "2"}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{
       "2", ",", "2", ",", "2", ",", "2", ",", "2", ",", "2", ",", "2", ",", 
        "2", ",", "2", ",", "2"}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{
       "2", ",", "2", ",", "2", ",", "2", ",", "2", ",", "2", ",", "2", ",", 
        "2", ",", "2", ",", "2"}], "}"}]}], "}"}], ",", "1"}], 
   "]"}]}]], "Input",
 CellChangeTimes->{{3.642307172543664*^9, 3.642307236414545*^9}, 
   3.642307375071673*^9, {3.642310451185691*^9, 3.642310451681561*^9}, {
   3.642310724634617*^9, 3.642310725164034*^9}}],

Cell[BoxData[
 RowBox[{"{", 
  RowBox[{
   RowBox[{"{", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", 
       "0", ",", "1", ",", "0"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
      "0", ",", "0", ",", "0", ",", "1", ",", "0", ",", "1", ",", "0", ",", 
       "0", ",", "0", ",", "0"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
      "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", 
       "0", ",", "0", ",", "0"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
      "0", ",", "0", ",", "0", ",", "0", ",", "1", ",", "0", ",", "0", ",", 
       "0", ",", "0", ",", "0"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
      "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", 
       "0", ",", "0", ",", "0"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
      "0", ",", "0", ",", "1", ",", "0", ",", "0", ",", "0", ",", "0", ",", 
       "0", ",", "0", ",", "0"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
      "1", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "1", ",", 
       "0", ",", "0", ",", "0"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
      "0", ",", "1", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", 
       "0", ",", "0", ",", "0"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
      "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", 
       "0", ",", "0", ",", "1"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
      "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", 
       "1", ",", "0", ",", "0"}], "}"}]}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "0", ",", "0", ",", "0", ",", "0", ",", "1", ",", "0", ",", "0", ",", 
       "0", ",", "1", ",", "0"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
      "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "1", ",", 
       "0", ",", "0", ",", "0"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
      "0", ",", "0", ",", "0", ",", "1", ",", "0", ",", "0", ",", "0", ",", 
       "0", ",", "0", ",", "1"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
      "0", ",", "1", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", 
       "0", ",", "0", ",", "0"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
      "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", 
       "0", ",", "0", ",", "0"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
      "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", 
       "0", ",", "0", ",", "0"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
      "1", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", 
       "0", ",", "0", ",", "0"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
      "0", ",", "0", ",", "1", ",", "0", ",", "0", ",", "0", ",", "0", ",", 
       "0", ",", "0", ",", "0"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
      "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", 
       "0", ",", "0", ",", "0"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
      "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "1", ",", "0", ",", 
       "1", ",", "0", ",", "0"}], "}"}]}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "1", ",", 
       "0", ",", "0", ",", "0"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
      "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", 
       "0", ",", "0", ",", "0"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
      "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", 
       "0", ",", "1", ",", "0"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
      "1", ",", "1", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", 
       "0", ",", "0", ",", "0"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
      "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", 
       "0", ",", "0", ",", "0"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
      "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", 
       "0", ",", "0", ",", "0"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
      "0", ",", "0", ",", "0", ",", "0", ",", "1", ",", "1", ",", "0", ",", 
       "0", ",", "0", ",", "0"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
      "0", ",", "0", ",", "1", ",", "0", ",", "0", ",", "0", ",", "0", ",", 
       "1", ",", "0", ",", "0"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
      "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", 
       "0", ",", "0", ",", "0"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
      "0", ",", "0", ",", "0", ",", "1", ",", "0", ",", "0", ",", "0", ",", 
       "0", ",", "0", ",", "1"}], "}"}]}], "}"}]}], "}"}]], "Output",
 CellChangeTimes->{
  3.642307238463759*^9, 3.642307377412858*^9, 3.642307958729604*^9, 
   3.642310520389979*^9, {3.64231067175851*^9, 3.6423107003070393`*^9}, 
   3.642310879040522*^9, 3.642311070696342*^9, 3.642311223910417*^9, 
   3.687877810848044*^9, 3.687878597538733*^9, 3.687925845327777*^9}]
}, Open  ]],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"TUmatchMatrix", "\[Equal]", "TUmatchMatrix2"}]], "Input",
 CellChangeTimes->{{3.642307971241332*^9, 3.642307982498884*^9}, {
  3.642310479303022*^9, 3.642310483465802*^9}}],

Cell[BoxData["True"], "Output",
 CellChangeTimes->{
  3.642307983356431*^9, 3.642310520428269*^9, {3.642310671808074*^9, 
   3.642310700362966*^9}, 3.6423108791502542`*^9, 3.6423110718683577`*^9, 
   3.642311223914863*^9, 3.687877814050988*^9, 3.6878786000498447`*^9, 
   3.687925848439762*^9}]
}, Open  ]],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"TUmatchMatrix2", "=", 
  RowBox[{
   StyleBox["CmatchMatrix",
    Background->RGBColor[1, 1, 0]], "[", 
   RowBox[{"TUpayoffMatrix", ",", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "2", ",", "0", ",", "1", ",", "3", ",", "2", ",", "1", ",", "2", ",", 
        "2", ",", "2", ",", "1"}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{
       "8", ",", "2", ",", "2", ",", "2", ",", "2", ",", "2", ",", "2", ",", 
        "2", ",", "2", ",", "2"}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{
       "2", ",", "2", ",", "2", ",", "2", ",", "2", ",", "2", ",", "3", ",", 
        "2", ",", "2", ",", "2"}], "}"}]}], "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "2", ",", "0", ",", "1", ",", "3", ",", "2", ",", "1", ",", "2", ",", 
        "2", ",", "2", ",", "1"}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{
       "8", ",", "2", ",", "2", ",", "2", ",", "2", ",", "2", ",", "2", ",", 
        "2", ",", "2", ",", "2"}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{
       "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", 
        "0", ",", "0", ",", "1"}], "}"}]}], "}"}]}], "]"}]}]], "Input",
 CellChangeTimes->{{3.642307172543664*^9, 3.642307236414545*^9}, 
   3.642307375071673*^9, {3.6423082208147297`*^9, 3.6423082828893633`*^9}, {
   3.6423104870189734`*^9, 3.642310487472363*^9}, {3.6423107202191153`*^9, 
   3.642310720489188*^9}}],

Cell[BoxData[
 RowBox[{"{", 
  RowBox[{
   RowBox[{"{", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "1", ",", "0", ",", 
       "0", ",", "1", ",", "0"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
      "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", 
       "0", ",", "0", ",", "0"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
      "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", 
       "0", ",", "1", ",", "0"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
      "1", ",", "0", ",", "0", ",", "1", ",", "1", ",", "0", ",", "0", ",", 
       "0", ",", "0", ",", "0"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
      "0", ",", "0", ",", "0", ",", "1", ",", "0", ",", "0", ",", "1", ",", 
       "0", ",", "0", ",", "0"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
      "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", 
       "1", ",", "0", ",", "0"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
      "1", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "1", ",", 
       "0", ",", "0", ",", "0"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
      "0", ",", "0", ",", "0", ",", "1", ",", "1", ",", "0", ",", "0", ",", 
       "0", ",", "0", ",", "0"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
      "0", ",", "0", ",", "1", ",", "0", ",", "0", ",", "0", ",", "0", ",", 
       "0", ",", "0", ",", "1"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
      "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", 
       "1", ",", "0", ",", "0"}], "}"}]}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "1", ",", "1", ",", "0", ",", "1", ",", "1", ",", "1", ",", "1", ",", 
       "0", ",", "1", ",", "1"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
      "1", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "1", ",", 
       "0", ",", "0", ",", "0"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
      "0", ",", "0", ",", "1", ",", "0", ",", "0", ",", "0", ",", "0", ",", 
       "0", ",", "0", ",", "1"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
      "1", ",", "1", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", 
       "0", ",", "0", ",", "0"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
      "1", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", 
       "1", ",", "0", ",", "0"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
      "1", ",", "0", ",", "0", ",", "1", ",", "0", ",", "0", ",", "0", ",", 
       "0", ",", "0", ",", "0"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
      "1", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", 
       "0", ",", "1", ",", "0"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
      "1", ",", "0", ",", "1", ",", "0", ",", "0", ",", "0", ",", "0", ",", 
       "0", ",", "0", ",", "0"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
      "1", ",", "0", ",", "0", ",", "0", ",", "1", ",", "0", ",", "0", ",", 
       "0", ",", "0", ",", "0"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
      "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "1", ",", "0", ",", 
       "1", ",", "0", ",", "0"}], "}"}]}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", 
       "0", ",", "0", ",", "0"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
      "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", 
       "0", ",", "0", ",", "0"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
      "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", 
       "0", ",", "0", ",", "0"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
      "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", 
       "0", ",", "0", ",", "0"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
      "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", 
       "0", ",", "0", ",", "0"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
      "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", 
       "0", ",", "0", ",", "0"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
      "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", 
       "0", ",", "0", ",", "0"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
      "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", 
       "0", ",", "0", ",", "0"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
      "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", 
       "0", ",", "0", ",", "0"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
      "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", 
       "0", ",", "0", ",", "1"}], "}"}]}], "}"}]}], "}"}]], "Output",
 CellChangeTimes->{{3.642308244306979*^9, 3.642308283751137*^9}, 
   3.642310520467792*^9, {3.642310671876874*^9, 3.642310700430065*^9}, 
   3.642310879720673*^9, 3.642311072758895*^9, 3.642311224029127*^9, 
   3.687877824571457*^9, 3.6878786013905*^9, 3.687925849766123*^9}]
}, Open  ]],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"quotas", "[", "matchMatrix", "]"}]], "Input",
 CellChangeTimes->{{3.687877836057673*^9, 3.687877893418015*^9}}],

Cell[BoxData[
 RowBox[{"{", 
  RowBox[{
   RowBox[{"{", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "2", ",", "0", ",", "1", ",", "3", ",", "2", ",", "1", ",", "2", ",", 
       "2", ",", "2", ",", "1"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
      "8", ",", "2", ",", "2", ",", "2", ",", "2", ",", "2", ",", "2", ",", 
       "2", ",", "2", ",", "2"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
      "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", 
       "0", ",", "0", ",", "1"}], "}"}]}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "2", ",", "0", ",", "1", ",", "3", ",", "2", ",", "1", ",", "2", ",", 
       "2", ",", "2", ",", "1"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
      "8", ",", "2", ",", "2", ",", "2", ",", "2", ",", "2", ",", "2", ",", 
       "2", ",", "2", ",", "2"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
      "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", 
       "0", ",", "0", ",", "1"}], "}"}]}], "}"}]}], "}"}]], "Output",
 CellChangeTimes->{{3.6878778488915443`*^9, 3.687877883592516*^9}, 
   3.687878604510825*^9, 3.6879258518224573`*^9}]
}, Open  ]],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"matchMatrix", "==", "TUmatchMatrix2"}]], "Input",
 CellChangeTimes->{{3.6878778961251497`*^9, 3.687877943001815*^9}}],

Cell[BoxData["True"], "Output",
 CellChangeTimes->{{3.68787790852485*^9, 3.687877943928334*^9}, 
   3.687878606474394*^9, 3.687925854794303*^9}]
}, Open  ]]
}, Open  ]]
}, Open  ]],

Cell[CellGroupData[{

Cell["Trace quotas from matchMatrix", "Subsection",
 CellChangeTimes->{{3.6423093280832243`*^9, 3.642309339756105*^9}}],

Cell[BoxData[{
 RowBox[{
  RowBox[{"ClearAll", "[", "quotas", "]"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"quotas", "::", "usage"}], "=", 
   "\"\<quotas[matchMatrix] returns the list {quotaU,quotaD}. Quota is \
defined for each stream u and d.\>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"quotas", "[", "matchMatrix_", "]"}], ":=", 
  RowBox[{"{", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{
      RowBox[{"(", 
       RowBox[{"Total", "/@", "#"}], ")"}], "&"}], "/@", "matchMatrix"}], ",",
     "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{
      RowBox[{"(", 
       RowBox[{"Total", "/@", 
        RowBox[{"(", 
         RowBox[{"Transpose", "@", "#"}], ")"}]}], ")"}], "&"}], "/@", 
     "matchMatrix"}]}], "\[IndentingNewLine]", "}"}]}]}], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.642303740898554*^9, 3.642303781931591*^9}, {
  3.6423093502911158`*^9, 3.642309374194827*^9}, {3.642309714805132*^9, 
  3.642309777526725*^9}, {3.697048434297811*^9, 3.6970484358083277`*^9}},
 Background->RGBColor[0.88, 1, 0.88]],

Cell[CellGroupData[{

Cell["Unit testing", "Subsubsection",
 CellChangeTimes->{{3.642309619493703*^9, 3.642309622214303*^9}}],

Cell[BoxData[
 RowBox[{"ClearAll", "[", "\"\<TU*\>\"", "]"}]], "Input",
 CellChangeTimes->{{3.642309784925255*^9, 3.642309792348068*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"TUmatchMatrix", "=", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
        "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "1", ",", "0", ",", 
         "0", ",", "1", ",", "0"}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{
        "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", 
         "0", ",", "0", ",", "0"}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{
        "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", 
         "0", ",", "1", ",", "0"}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{
        "1", ",", "0", ",", "0", ",", "1", ",", "1", ",", "0", ",", "0", ",", 
         "0", ",", "0", ",", "0"}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{
        "0", ",", "0", ",", "0", ",", "1", ",", "0", ",", "0", ",", "1", ",", 
         "0", ",", "0", ",", "0"}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{
        "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", 
         "1", ",", "0", ",", "0"}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{
        "1", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "1", ",", 
         "0", ",", "0", ",", "0"}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{
        "0", ",", "0", ",", "0", ",", "1", ",", "1", ",", "0", ",", "0", ",", 
         "0", ",", "0", ",", "0"}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{
        "0", ",", "0", ",", "1", ",", "0", ",", "0", ",", "0", ",", "0", ",", 
         "0", ",", "0", ",", "1"}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{
        "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", 
         "1", ",", "0", ",", "0"}], "}"}]}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
        "1", ",", "1", ",", "0", ",", "1", ",", "1", ",", "1", ",", "1", ",", 
         "0", ",", "1", ",", "1"}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{
        "1", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "1", ",", 
         "0", ",", "0", ",", "0"}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{
        "0", ",", "0", ",", "1", ",", "0", ",", "0", ",", "0", ",", "0", ",", 
         "0", ",", "0", ",", "1"}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{
        "1", ",", "1", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", 
         "0", ",", "0", ",", "0"}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{
        "1", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", 
         "1", ",", "0", ",", "0"}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{
        "1", ",", "0", ",", "0", ",", "1", ",", "0", ",", "0", ",", "0", ",", 
         "0", ",", "0", ",", "0"}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{
        "1", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", 
         "0", ",", "1", ",", "0"}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{
        "1", ",", "0", ",", "1", ",", "0", ",", "0", ",", "0", ",", "0", ",", 
         "0", ",", "0", ",", "0"}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{
        "1", ",", "0", ",", "0", ",", "0", ",", "1", ",", "0", ",", "0", ",", 
         "0", ",", "0", ",", "0"}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{
        "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "1", ",", "0", ",", 
         "1", ",", "0", ",", "0"}], "}"}]}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
        "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", 
         "0", ",", "0", ",", "0"}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{
        "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", 
         "0", ",", "0", ",", "0"}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{
        "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", 
         "0", ",", "0", ",", "0"}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{
        "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", 
         "0", ",", "0", ",", "0"}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{
        "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", 
         "0", ",", "0", ",", "0"}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{
        "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", 
         "0", ",", "0", ",", "0"}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{
        "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", 
         "0", ",", "0", ",", "0"}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{
        "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", 
         "0", ",", "0", ",", "0"}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{
        "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", 
         "0", ",", "0", ",", "0"}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{
        "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", 
         "0", ",", "0", ",", "1"}], "}"}]}], "}"}]}], "}"}]}], ";"}]], "Input",
 CellChangeTimes->{{3.642309594735303*^9, 3.642309614299549*^9}, {
  3.642309782026322*^9, 3.6423097832211447`*^9}}],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{
  RowBox[{"TUmatchMatrix", "[", 
   RowBox[{"[", "1", "]"}], "]"}], "//", "MatrixForm"}]], "Input",
 CellChangeTimes->{{3.6423096483929033`*^9, 3.642309648778842*^9}}],

Cell[BoxData[
 TagBox[
  RowBox[{"(", "\[NoBreak]", GridBox[{
     {"0", "0", "0", "0", "0", "1", "0", "0", "1", "0"},
     {"0", "0", "0", "0", "0", "0", "0", "0", "0", "0"},
     {"0", "0", "0", "0", "0", "0", "0", "0", "1", "0"},
     {"1", "0", "0", "1", "1", "0", "0", "0", "0", "0"},
     {"0", "0", "0", "1", "0", "0", "1", "0", "0", "0"},
     {"0", "0", "0", "0", "0", "0", "0", "1", "0", "0"},
     {"1", "0", "0", "0", "0", "0", "1", "0", "0", "0"},
     {"0", "0", "0", "1", "1", "0", "0", "0", "0", "0"},
     {"0", "0", "1", "0", "0", "0", "0", "0", "0", "1"},
     {"0", "0", "0", "0", "0", "0", "0", "1", "0", "0"}
    },
    GridBoxAlignment->{
     "Columns" -> {{Center}}, "ColumnsIndexed" -> {}, "Rows" -> {{Baseline}}, 
      "RowsIndexed" -> {}},
    GridBoxSpacings->{"Columns" -> {
        Offset[0.27999999999999997`], {
         Offset[0.7]}, 
        Offset[0.27999999999999997`]}, "ColumnsIndexed" -> {}, "Rows" -> {
        Offset[0.2], {
         Offset[0.4]}, 
        Offset[0.2]}, "RowsIndexed" -> {}}], "\[NoBreak]", ")"}],
  Function[BoxForm`e$, 
   MatrixForm[BoxForm`e$]]]], "Output",
 CellChangeTimes->{3.642309649601829*^9, 3.642309795121808*^9}]
}, Open  ]],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"Total", "/@", 
  RowBox[{"(", 
   RowBox[{"TUmatchMatrix", "[", 
    RowBox[{"[", "1", "]"}], "]"}], ")"}]}]], "Input",
 CellChangeTimes->{{3.642298933548697*^9, 3.642298984626255*^9}, {
  3.642299038079836*^9, 3.6422990398418303`*^9}, {3.6423096684320517`*^9, 
  3.642309668904066*^9}, {3.642309795909629*^9, 3.642309797404664*^9}}],

Cell[BoxData[
 RowBox[{"{", 
  RowBox[{
  "2", ",", "0", ",", "1", ",", "3", ",", "2", ",", "1", ",", "2", ",", "2", 
   ",", "2", ",", "1"}], "}"}]], "Output",
 CellChangeTimes->{{3.642298939203779*^9, 3.642298950894259*^9}, 
   3.642298985012514*^9, 3.6422990406705427`*^9, 3.642308105787703*^9, 
   3.6423096709453297`*^9, 3.64230979796542*^9}]
}, Open  ]],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"Total", "/@", 
  RowBox[{"(", 
   RowBox[{"Transpose", "@", 
    RowBox[{"(", 
     RowBox[{"TUmatchMatrix", "[", 
      RowBox[{"[", "1", "]"}], "]"}], ")"}]}], ")"}]}]], "Input",
 CellChangeTimes->{{3.6422989960643873`*^9, 3.6422990111697598`*^9}, {
  3.6422990445799017`*^9, 3.6422990580672817`*^9}, {3.642309674860614*^9, 
  3.642309675321024*^9}}],

Cell[BoxData[
 RowBox[{"{", 
  RowBox[{
  "2", ",", "0", ",", "1", ",", "3", ",", "2", ",", "1", ",", "2", ",", "2", 
   ",", "2", ",", "1"}], "}"}]], "Output",
 CellChangeTimes->{
  3.642299011660445*^9, {3.64229904748363*^9, 3.6422990590427427`*^9}, 
   3.642308106722518*^9, 3.6423096766659*^9, 3.6423097987349367`*^9}]
}, Open  ]],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"(", 
    RowBox[{"Total", "/@", "#"}], ")"}], "&"}], "/@", 
  "TUmatchMatrix"}]], "Input",
 CellChangeTimes->{{3.642303625840535*^9, 3.642303643107699*^9}, {
  3.64230968018001*^9, 3.642309680528294*^9}}],

Cell[BoxData[
 RowBox[{"{", 
  RowBox[{
   RowBox[{"{", 
    RowBox[{
    "2", ",", "0", ",", "1", ",", "3", ",", "2", ",", "1", ",", "2", ",", "2",
      ",", "2", ",", "1"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{
    "8", ",", "2", ",", "2", ",", "2", ",", "2", ",", "2", ",", "2", ",", "2",
      ",", "2", ",", "2"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{
    "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0",
      ",", "0", ",", "1"}], "}"}]}], "}"}]], "Output",
 CellChangeTimes->{3.642303644113421*^9, 3.642308107404504*^9, 
  3.642309681379034*^9, 3.6423097995631247`*^9}]
}, Open  ]],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"(", 
    RowBox[{"Total", "/@", 
     RowBox[{"(", 
      RowBox[{"Transpose", "@", "#"}], ")"}]}], ")"}], "&"}], "/@", 
  "TUmatchMatrix"}]], "Input",
 CellChangeTimes->{{3.6423036693529673`*^9, 3.642303678455509*^9}, {
  3.642309685792288*^9, 3.64230968621805*^9}}],

Cell[BoxData[
 RowBox[{"{", 
  RowBox[{
   RowBox[{"{", 
    RowBox[{
    "2", ",", "0", ",", "1", ",", "3", ",", "2", ",", "1", ",", "2", ",", "2",
      ",", "2", ",", "1"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{
    "8", ",", "2", ",", "2", ",", "2", ",", "2", ",", "2", ",", "2", ",", "2",
      ",", "2", ",", "2"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{
    "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0",
      ",", "0", ",", "1"}], "}"}]}], "}"}]], "Output",
 CellChangeTimes->{3.642303679685501*^9, 3.642308108333561*^9, 
  3.6423096871252813`*^9, 3.642309800305532*^9}]
}, Open  ]],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{
  StyleBox["quotas",
   Background->RGBColor[1, 1, 0]], "[", "TUmatchMatrix", "]"}]], "Input",
 CellChangeTimes->{{3.642303786746523*^9, 3.642303793384987*^9}, {
  3.642309690978444*^9, 3.642309692056089*^9}}],

Cell[BoxData[
 RowBox[{"{", 
  RowBox[{
   RowBox[{"{", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "2", ",", "0", ",", "1", ",", "3", ",", "2", ",", "1", ",", "2", ",", 
       "2", ",", "2", ",", "1"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
      "8", ",", "2", ",", "2", ",", "2", ",", "2", ",", "2", ",", "2", ",", 
       "2", ",", "2", ",", "2"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
      "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", 
       "0", ",", "0", ",", "1"}], "}"}]}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "2", ",", "0", ",", "1", ",", "3", ",", "2", ",", "1", ",", "2", ",", 
       "2", ",", "2", ",", "1"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
      "8", ",", "2", ",", "2", ",", "2", ",", "2", ",", "2", ",", "2", ",", 
       "2", ",", "2", ",", "2"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
      "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", "0", ",", 
       "0", ",", "0", ",", "1"}], "}"}]}], "}"}]}], "}"}]], "Output",
 CellChangeTimes->{3.64230379384058*^9, 3.642308110188491*^9, 
  3.642309692899769*^9, 3.6423098010380898`*^9}]
}, Open  ]]
}, Open  ]]
}, Open  ]],

Cell[CellGroupData[{

Cell["Cmates[matchMatrix]", "Subsection",
 CellChangeTimes->{
  3.6117411131376095`*^9, 3.611741233674157*^9, {3.611741277829609*^9, 
   3.6117412916970325`*^9}, {3.611912880528715*^9, 3.611912891202575*^9}, {
   3.6119140668733816`*^9, 3.6119141092559533`*^9}, {3.61191461056221*^9, 
   3.6119146122298455`*^9}, {3.611916770293911*^9, 3.6119167752215366`*^9}, {
   3.611917597165457*^9, 3.611917598356863*^9}, 3.611917663199075*^9, {
   3.6119182097453203`*^9, 3.6119182120154114`*^9}, {3.611919677728411*^9, 
   3.6119196811942315`*^9}, 3.611921442829568*^9}],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
   "C", " ", "in", " ", "front", " ", "of", " ", "the", " ", "name", " ", 
    "means", " ", "create"}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"ClearAll", "[", "Cmates", "]"}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"Cmates", "::", "usage"}], "=", 
     "\"\<\nCmates[matchMatrix] simplifies the matchMatrix to a list of \
triples that define matches across all markets. It provides another way to \
express all the matching information that is, which upstream is matched with \
which downstream and in which market. The output consists of a list of lists \
of triples each of which has the following structure: \
{market_index,upstream_index,downstream_index}.\nOutput \
example:{{{1,1,3},{1,3,1},{1,3,2}},{{2,1,1},{2,2,1},{2,2,3},{2,3,2}}}. In \
this example we have 2 lists, one per market and each inner list contains the \
triples. Note that in market 1, upstream agent 2 is not contributing which is \
fine. \nThis function is mainly used for the calculation of the total payoff \
- see Ctotalpayoff routine.\>\""}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"Cmates", "[", "matchMatrix_", "]"}], ":=", 
     RowBox[{"mates", "=", 
      RowBox[{"GatherBy", "[", 
       RowBox[{
        RowBox[{"Position", "[", 
         RowBox[{"matchMatrix", ",", "1", ",", 
          RowBox[{"{", "3", "}"}]}], "]"}], ",", "First"}], "]"}]}]}], 
    ";"}]}]}]], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.611654102177257*^9, 3.6116542218406477`*^9}, 
   3.611654420939027*^9, {3.6116544925174885`*^9, 3.6116545056894417`*^9}, {
   3.6116545421489096`*^9, 3.611654664496849*^9}, {3.611741108152258*^9, 
   3.611741109824133*^9}, {3.6117412417288446`*^9, 3.6117412863497148`*^9}, {
   3.6117415360333033`*^9, 3.611741537631454*^9}, {3.611916949583702*^9, 
   3.611917018355516*^9}, {3.611917052260789*^9, 3.611917084657938*^9}, {
   3.611917604796316*^9, 3.6119176077787385`*^9}, {3.6119193255870132`*^9, 
   3.6119193339679804`*^9}, {3.611919688618336*^9, 3.61191969788384*^9}, {
   3.6327390860990343`*^9, 3.6327391054730577`*^9}, {3.63273915881715*^9, 
   3.632739288309473*^9}, {3.632739324336192*^9, 3.6327393442238874`*^9}, 
   3.6327393877179394`*^9, {3.6880082323252983`*^9, 3.6880082365448513`*^9}, {
   3.697048184780802*^9, 3.69704819864695*^9}},
 Background->RGBColor[0.88, 1, 0.88]],

Cell[CellGroupData[{

Cell["Example", "Subsubsection",
 CellChangeTimes->{{3.611917258849233*^9, 3.6119172603767457`*^9}}],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"mates", "=", 
  RowBox[{"Cmates", "[", "matchMatrix", "]"}]}]], "Input",
 CellChangeTimes->{{3.626171756051646*^9, 3.6261717660887556`*^9}}],

Cell[BoxData[
 RowBox[{"{", 
  RowBox[{
   RowBox[{"{", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"1", ",", "1", ",", "9"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"1", ",", "2", ",", "4"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"1", ",", "2", ",", "6"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"1", ",", "4", ",", "5"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"1", ",", "6", ",", "3"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"1", ",", "7", ",", "1"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"1", ",", "7", ",", "7"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"1", ",", "8", ",", "2"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"1", ",", "9", ",", "10"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"1", ",", "10", ",", "8"}], "}"}]}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"2", ",", "1", ",", "5"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"2", ",", "1", ",", "9"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"2", ",", "2", ",", "7"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"2", ",", "3", ",", "4"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"2", ",", "3", ",", "10"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"2", ",", "4", ",", "2"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"2", ",", "7", ",", "1"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"2", ",", "8", ",", "3"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"2", ",", "10", ",", "6"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"2", ",", "10", ",", "8"}], "}"}]}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"3", ",", "1", ",", "7"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"3", ",", "3", ",", "9"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"3", ",", "4", ",", "1"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"3", ",", "4", ",", "2"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"3", ",", "7", ",", "5"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"3", ",", "7", ",", "6"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"3", ",", "8", ",", "3"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"3", ",", "8", ",", "8"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"3", ",", "10", ",", "4"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"3", ",", "10", ",", "10"}], "}"}]}], "}"}]}], "}"}]], "Output",
 CellChangeTimes->{
  3.626171768333873*^9, {3.626173487970665*^9, 3.626173497742124*^9}, 
   3.6263306991772165`*^9, 3.6263322923959665`*^9}]
}, Open  ]],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"Cmates", "[", "\[IndentingNewLine]", 
  RowBox[{"{", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"{", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"0", ",", "0", ",", "1"}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"0", ",", "0", ",", "0"}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"1", ",", "1", ",", "0"}], "}"}]}], "\[IndentingNewLine]", 
     "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{"{", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"1", ",", "0", ",", "0", ",", "0"}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"1", ",", "0", ",", "1", ",", "0"}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"0", ",", "1", ",", "0", ",", "0"}], "}"}]}], 
     "\[IndentingNewLine]", "}"}]}], "\[IndentingNewLine]", "}"}], 
  "\[IndentingNewLine]", "]"}]], "Input",
 CellChangeTimes->{{3.611917086911497*^9, 3.61191710678026*^9}, {
   3.61191714723989*^9, 3.6119172206057825`*^9}, 3.6119176172091846`*^9, {
   3.6119179568491726`*^9, 3.611917958605032*^9}, {3.611918583279616*^9, 
   3.611918584865553*^9}, {3.6119194195411544`*^9, 3.611919434394255*^9}, {
   3.611919648556239*^9, 3.6119196538483367`*^9}, {3.6263323385990915`*^9, 
   3.6263323476459665`*^9}}],

Cell[BoxData[
 RowBox[{"{", 
  RowBox[{
   RowBox[{"{", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"1", ",", "1", ",", "3"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"1", ",", "3", ",", "1"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"1", ",", "3", ",", "2"}], "}"}]}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"2", ",", "1", ",", "1"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"2", ",", "2", ",", "1"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"2", ",", "2", ",", "3"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"2", ",", "3", ",", "2"}], "}"}]}], "}"}]}], "}"}]], "Output",
 CellChangeTimes->{3.6263334678022165`*^9}]
}, Open  ]]
}, Open  ]]
}, Open  ]],

Cell[CellGroupData[{

Cell["Cmate[matchMatrix]", "Subsection",
 CellChangeTimes->{
  3.6117411131376095`*^9, 3.611741233674157*^9, {3.611741277829609*^9, 
   3.6117412916970325`*^9}, {3.611912880528715*^9, 3.611912891202575*^9}, {
   3.6119140668733816`*^9, 3.6119141092559533`*^9}, {3.61191461056221*^9, 
   3.6119146122298455`*^9}, {3.611916770293911*^9, 3.6119167752215366`*^9}, {
   3.611917597165457*^9, 3.611917598356863*^9}, 3.611917663199075*^9, {
   3.6119182097453203`*^9, 3.6119182120154114`*^9}, {3.611919677728411*^9, 
   3.6119196811942315`*^9}, {3.611920435131773*^9, 3.6119204429100695`*^9}, {
   3.611920552241973*^9, 3.611920556548978*^9}, 3.6119214405720224`*^9}],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
   "C", " ", "in", " ", "front", " ", "of", " ", "the", " ", "name", " ", 
    "means", " ", "create"}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"ClearAll", "[", "Cmate", "]"}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"Cmate", "::", "usage"}], "=", 
     "\"\<Cmate[matchMatrix] simplifies the matchMatrix from the original \
code by Santiago & Fox, to a matrix format which consists of lists of pairs, \
one pair per market. Here, each pair has the following structure: \
{{{1},{2},...,{noU within this market}},{{downstreams that are matched with \
upstream1},{downstreams that are matched with upstream2},...,{downstreams \
that are matched with upstream noU}}.\nExample : \
{{{{1},{2},{3}},{{3},{},{1,2}}},{{{1},{2},{3}},{{1},{1,3},{2}}}}.  In this \
example, there are three upstream and three downstream agents in each market, \
indexed 1, 2, 3. In the first market, upstream 1 is matched with downstream \
3, upstream 2 is not matched, and upstream 3 is matched with downstream 1 and \
 2. In the second market, upstream 1 is matched with downstream 1, upstream 2 \
with downstream 1 and 3, and upstream 3 with downstream 2.  \nThe \
mate=Cmate[matchMatrix] is later fed into the Cineqmembers routine.\>\""}], 
    ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"Cmate", "[", "matchMatrix_", "]"}], ":=", 
    RowBox[{"mate", "=", 
     RowBox[{"(", 
      RowBox[{
       RowBox[{
        RowBox[{"(", 
         RowBox[{"Transpose", "@", 
          RowBox[{"MapIndexed", "[", 
           RowBox[{
            RowBox[{
             RowBox[{"{", 
              RowBox[{
               RowBox[{"{", 
                RowBox[{"First", "@", "#2"}], "}"}], ",", 
               RowBox[{"Flatten", "@", 
                RowBox[{"Position", "[", 
                 RowBox[{"#1", ",", "1"}], "]"}]}]}], "}"}], "&"}], ",", 
            "#"}], "]"}]}], ")"}], "&"}], "/@", "matchMatrix"}], 
      ")"}]}]}]}]}]], "Input",
 InitializationCell->True,
 CellChangeTimes->{{3.611654102177257*^9, 3.6116542218406477`*^9}, 
   3.611654420939027*^9, {3.6116544925174885`*^9, 3.6116545056894417`*^9}, {
   3.6116545421489096`*^9, 3.611654664496849*^9}, {3.611741108152258*^9, 
   3.611741109824133*^9}, {3.6117412417288446`*^9, 3.6117412863497148`*^9}, {
   3.6117415360333033`*^9, 3.611741537631454*^9}, {3.611916949583702*^9, 
   3.611917018355516*^9}, {3.611917052260789*^9, 3.611917084657938*^9}, {
   3.611917604796316*^9, 3.6119176077787385`*^9}, {3.6119193255870132`*^9, 
   3.6119193339679804`*^9}, {3.611919688618336*^9, 3.61191969788384*^9}, {
   3.611920445930352*^9, 3.611920485267894*^9}, {3.611920539213221*^9, 
   3.6119205651999493`*^9}, {3.6327393936307545`*^9, 
   3.6327395532618265`*^9}, {3.688008247756948*^9, 3.6880082620889273`*^9}, 
   3.697048280934793*^9},
 Background->RGBColor[0.88, 1, 0.88]],

Cell[CellGroupData[{

Cell["Example", "Subsubsection",
 CellChangeTimes->{{3.611917258849233*^9, 3.6119172603767457`*^9}}],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"mate", "=", 
  RowBox[{"Cmate", "[", "matchMatrix", "]"}]}]], "Input",
 CellChangeTimes->{{3.611920863325688*^9, 3.6119208715021544`*^9}}],

Cell[BoxData[
 RowBox[{"{", 
  RowBox[{
   RowBox[{"{", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", "1", "}"}], ",", 
       RowBox[{"{", "2", "}"}], ",", 
       RowBox[{"{", "3", "}"}], ",", 
       RowBox[{"{", "4", "}"}], ",", 
       RowBox[{"{", "5", "}"}], ",", 
       RowBox[{"{", "6", "}"}], ",", 
       RowBox[{"{", "7", "}"}], ",", 
       RowBox[{"{", "8", "}"}], ",", 
       RowBox[{"{", "9", "}"}], ",", 
       RowBox[{"{", "10", "}"}]}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", "9", "}"}], ",", 
       RowBox[{"{", 
        RowBox[{"4", ",", "6"}], "}"}], ",", 
       RowBox[{"{", "}"}], ",", 
       RowBox[{"{", "5", "}"}], ",", 
       RowBox[{"{", "}"}], ",", 
       RowBox[{"{", "3", "}"}], ",", 
       RowBox[{"{", 
        RowBox[{"1", ",", "7"}], "}"}], ",", 
       RowBox[{"{", "2", "}"}], ",", 
       RowBox[{"{", "10", "}"}], ",", 
       RowBox[{"{", "8", "}"}]}], "}"}]}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", "1", "}"}], ",", 
       RowBox[{"{", "2", "}"}], ",", 
       RowBox[{"{", "3", "}"}], ",", 
       RowBox[{"{", "4", "}"}], ",", 
       RowBox[{"{", "5", "}"}], ",", 
       RowBox[{"{", "6", "}"}], ",", 
       RowBox[{"{", "7", "}"}], ",", 
       RowBox[{"{", "8", "}"}], ",", 
       RowBox[{"{", "9", "}"}], ",", 
       RowBox[{"{", "10", "}"}]}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"5", ",", "9"}], "}"}], ",", 
       RowBox[{"{", "7", "}"}], ",", 
       RowBox[{"{", 
        RowBox[{"4", ",", "10"}], "}"}], ",", 
       RowBox[{"{", "2", "}"}], ",", 
       RowBox[{"{", "}"}], ",", 
       RowBox[{"{", "}"}], ",", 
       RowBox[{"{", "1", "}"}], ",", 
       RowBox[{"{", "3", "}"}], ",", 
       RowBox[{"{", "}"}], ",", 
       RowBox[{"{", 
        RowBox[{"6", ",", "8"}], "}"}]}], "}"}]}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", "1", "}"}], ",", 
       RowBox[{"{", "2", "}"}], ",", 
       RowBox[{"{", "3", "}"}], ",", 
       RowBox[{"{", "4", "}"}], ",", 
       RowBox[{"{", "5", "}"}], ",", 
       RowBox[{"{", "6", "}"}], ",", 
       RowBox[{"{", "7", "}"}], ",", 
       RowBox[{"{", "8", "}"}], ",", 
       RowBox[{"{", "9", "}"}], ",", 
       RowBox[{"{", "10", "}"}]}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", "7", "}"}], ",", 
       RowBox[{"{", "}"}], ",", 
       RowBox[{"{", "9", "}"}], ",", 
       RowBox[{"{", 
        RowBox[{"1", ",", "2"}], "}"}], ",", 
       RowBox[{"{", "}"}], ",", 
       RowBox[{"{", "}"}], ",", 
       RowBox[{"{", 
        RowBox[{"5", ",", "6"}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{"3", ",", "8"}], "}"}], ",", 
       RowBox[{"{", "}"}], ",", 
       RowBox[{"{", 
        RowBox[{"4", ",", "10"}], "}"}]}], "}"}]}], "}"}]}], "}"}]], "Output",
 CellChangeTimes->{{3.6119208723618135`*^9, 3.611920880917739*^9}, 
   3.611921121672208*^9, 3.6119257225653768`*^9, {3.6261718500926085`*^9, 
   3.6261718605333567`*^9}, {3.6261734880908146`*^9, 3.6261734978212185`*^9}, 
   3.6263307072240915`*^9, 3.6263323038647165`*^9}]
}, Open  ]],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"Cmate", "[", "\[IndentingNewLine]", 
  RowBox[{"{", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"{", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"0", ",", "0", ",", "1"}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"0", ",", "0", ",", "0"}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"1", ",", "1", ",", "0"}], "}"}]}], "\[IndentingNewLine]", 
     "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{"{", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"1", ",", "0", ",", "0", ",", "0"}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"1", ",", "0", ",", "1", ",", "0"}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"0", ",", "1", ",", "0", ",", "0"}], "}"}]}], 
     "\[IndentingNewLine]", "}"}]}], "\[IndentingNewLine]", "}"}], 
  "\[IndentingNewLine]", "]"}]], "Input",
 CellChangeTimes->{3.6263323730834665`*^9}],

Cell[BoxData[
 RowBox[{"{", 
  RowBox[{
   RowBox[{"{", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", "1", "}"}], ",", 
       RowBox[{"{", "2", "}"}], ",", 
       RowBox[{"{", "3", "}"}]}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", "3", "}"}], ",", 
       RowBox[{"{", "}"}], ",", 
       RowBox[{"{", 
        RowBox[{"1", ",", "2"}], "}"}]}], "}"}]}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", "1", "}"}], ",", 
       RowBox[{"{", "2", "}"}], ",", 
       RowBox[{"{", "3", "}"}]}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{
       RowBox[{"{", "1", "}"}], ",", 
       RowBox[{"{", 
        RowBox[{"1", ",", "3"}], "}"}], ",", 
       RowBox[{"{", "2", "}"}]}], "}"}]}], "}"}]}], "}"}]], "Output",
 CellChangeTimes->{3.6263323740209665`*^9, 3.6327396115550833`*^9}]
}, Open  ]]
}, Open  ]]
}, Open  ]]
}, Open  ]]
},
AutoGeneratedPackage->Automatic,
WindowSize->{1198, 1061},
WindowMargins->{{Automatic, 11}, {25, 39}},
ShowSelection->True,
Magnification->1.25,
FrontEndVersion->"11.0 for Linux x86 (64-bit) (September 21, 2016)",
StyleDefinitions->"Default.nb"
]
(* End of Notebook Content *)

(* Internal cache information *)
(*CellTagsOutline
CellTagsIndex->{
 "Info43687938403-3708083"->{
  Cell[40747, 979, 601, 9, 117, "Print",
   CellTags->"Info43687938403-3708083"]},
 "Info723687930261-4066488"->{
  Cell[41509, 997, 1308, 23, 104, "Print",
   CellTags->"Info723687930261-4066488"]}
 }
*)
(*CellTagsIndex
CellTagsIndex->{
 {"Info43687938403-3708083", 100192, 2541},
 {"Info723687930261-4066488", 100306, 2544}
 }
*)
(*NotebookFileOutline
Notebook[{
Cell[CellGroupData[{
Cell[579, 22, 249, 3, 81, "Section"],
Cell[CellGroupData[{
Cell[853, 29, 110, 1, 44, "Subsubsection"],
Cell[966, 32, 272, 5, 67, "Text"],
Cell[1241, 39, 179, 4, 40, "Input"],
Cell[1423, 45, 148, 3, 40, "Input"],
Cell[1574, 50, 132, 2, 40, "Input"]
}, Open  ]],
Cell[CellGroupData[{
Cell[1743, 57, 186, 2, 56, "Subsection"],
Cell[1932, 61, 897, 20, 301, "Text"],
Cell[2832, 83, 10334, 241, 1689, "Input",
 InitializationCell->True],
Cell[CellGroupData[{
Cell[13191, 328, 203, 3, 44, "Subsubsection"],
Cell[13397, 333, 281, 4, 40, "Input"],
Cell[13681, 339, 251, 5, 40, "Input"],
Cell[13935, 346, 670, 12, 69, "Input"],
Cell[14608, 360, 3004, 82, 209, "Input"],
Cell[17615, 444, 984, 28, 98, "Input"],
Cell[18602, 474, 888, 22, 69, "Input"],
Cell[CellGroupData[{
Cell[19515, 500, 191, 3, 40, "Input"],
Cell[19709, 505, 707, 12, 40, "Output"]
}, Open  ]],
Cell[20431, 520, 1064, 22, 69, "Input"],
Cell[CellGroupData[{
Cell[21520, 546, 297, 6, 40, "Input"],
Cell[21820, 554, 1996, 39, 133, "Output"]
}, Open  ]],
Cell[23831, 596, 1207, 25, 69, "Input"],
Cell[CellGroupData[{
Cell[25063, 625, 297, 6, 40, "Input"],
Cell[25363, 633, 2050, 40, 133, "Output"]
}, Open  ]],
Cell[27428, 676, 1259, 26, 69, "Input"],
Cell[CellGroupData[{
Cell[28712, 706, 299, 6, 40, "Input"],
Cell[29014, 714, 2094, 40, 133, "Output"]
}, Open  ]],
Cell[31123, 757, 1517, 31, 97, "Input"],
Cell[CellGroupData[{
Cell[32665, 792, 299, 6, 40, "Input"],
Cell[32967, 800, 2094, 40, 133, "Output"]
}, Open  ]]
}, Closed]]
}, Open  ]],
Cell[CellGroupData[{
Cell[35122, 847, 144, 1, 56, "Subsection"],
Cell[35269, 850, 165, 2, 40, "Text"],
Cell[35437, 854, 5161, 117, 959, "Input",
 InitializationCell->True],
Cell[CellGroupData[{
Cell[40623, 975, 121, 2, 40, "Input"],
Cell[40747, 979, 601, 9, 117, "Print",
 CellTags->"Info43687938403-3708083"]
}, Open  ]],
Cell[CellGroupData[{
Cell[41385, 993, 121, 2, 40, "Input"],
Cell[41509, 997, 1308, 23, 104, "Print",
 CellTags->"Info723687930261-4066488"]
}, Open  ]],
Cell[CellGroupData[{
Cell[42854, 1025, 102, 1, 44, "Subsubsection"],
Cell[CellGroupData[{
Cell[42981, 1030, 337, 6, 40, "Input"],
Cell[43321, 1038, 716, 11, 40, "Output"]
}, Open  ]],
Cell[CellGroupData[{
Cell[44074, 1054, 348, 6, 40, "Input"],
Cell[44425, 1062, 2380, 34, 40, "Output"]
}, Open  ]],
Cell[46820, 1099, 137, 2, 40, "Input"],
Cell[46960, 1103, 776, 18, 70, "Input"],
Cell[47739, 1123, 459, 10, 40, "Input"],
Cell[48201, 1135, 275, 5, 67, "Text"],
Cell[48479, 1142, 470, 12, 40, "Input"],
Cell[CellGroupData[{
Cell[48974, 1158, 488, 9, 40, "Input"],
Cell[49465, 1169, 5192, 133, 349, "Output"]
}, Open  ]],
Cell[CellGroupData[{
Cell[54694, 1307, 906, 23, 69, "Input"],
Cell[55603, 1332, 5212, 133, 349, "Output"]
}, Open  ]],
Cell[CellGroupData[{
Cell[60852, 1470, 196, 3, 40, "Input"],
Cell[61051, 1475, 294, 5, 40, "Output"]
}, Open  ]],
Cell[CellGroupData[{
Cell[61382, 1485, 1500, 37, 97, "Input"],
Cell[62885, 1524, 5186, 132, 349, "Output"]
}, Open  ]],
Cell[CellGroupData[{
Cell[68108, 1661, 135, 2, 40, "Input"],
Cell[68246, 1665, 1197, 32, 69, "Output"]
}, Open  ]],
Cell[CellGroupData[{
Cell[69480, 1702, 141, 2, 40, "Input"],
Cell[69624, 1706, 144, 2, 40, "Output"]
}, Open  ]]
}, Open  ]]
}, Open  ]],
Cell[CellGroupData[{
Cell[69829, 1715, 119, 1, 56, "Subsection"],
Cell[69951, 1718, 1098, 28, 258, "Input",
 InitializationCell->True],
Cell[CellGroupData[{
Cell[71074, 1750, 103, 1, 44, "Subsubsection"],
Cell[71180, 1753, 137, 2, 40, "Input"],
Cell[71320, 1757, 5334, 132, 377, "Input"],
Cell[CellGroupData[{
Cell[76679, 1893, 191, 4, 40, "Input"],
Cell[76873, 1899, 1185, 26, 253, "Output"]
}, Open  ]],
Cell[CellGroupData[{
Cell[78095, 1930, 357, 7, 40, "Input"],
Cell[78455, 1939, 347, 7, 40, "Output"]
}, Open  ]],
Cell[CellGroupData[{
Cell[78839, 1951, 376, 9, 40, "Input"],
Cell[79218, 1962, 322, 7, 40, "Output"]
}, Open  ]],
Cell[CellGroupData[{
Cell[79577, 1974, 251, 7, 40, "Input"],
Cell[79831, 1983, 616, 16, 40, "Output"]
}, Open  ]],
Cell[CellGroupData[{
Cell[80484, 2004, 314, 9, 40, "Input"],
Cell[80801, 2015, 616, 16, 40, "Output"]
}, Open  ]],
Cell[CellGroupData[{
Cell[81454, 2036, 233, 5, 40, "Input"],
Cell[81690, 2043, 1191, 32, 69, "Output"]
}, Open  ]]
}, Open  ]]
}, Open  ]],
Cell[CellGroupData[{
Cell[82942, 2082, 561, 8, 56, "Subsection"],
Cell[83506, 2092, 2441, 46, 483, "Input",
 InitializationCell->True],
Cell[CellGroupData[{
Cell[85972, 2142, 100, 1, 44, "Subsubsection"],
Cell[CellGroupData[{
Cell[86097, 2147, 164, 3, 40, "Input"],
Cell[86264, 2152, 2511, 71, 153, "Output"]
}, Open  ]],
Cell[CellGroupData[{
Cell[88812, 2228, 1266, 28, 293, "Input"],
Cell[90081, 2258, 686, 21, 40, "Output"]
}, Open  ]]
}, Open  ]]
}, Open  ]],
Cell[CellGroupData[{
Cell[90828, 2286, 660, 9, 56, "Subsection"],
Cell[91491, 2297, 2923, 59, 566, "Input",
 InitializationCell->True],
Cell[CellGroupData[{
Cell[94439, 2360, 100, 1, 44, "Subsubsection"],
Cell[CellGroupData[{
Cell[94564, 2365, 162, 3, 40, "Input"],
Cell[94729, 2370, 3204, 93, 181, "Output"]
}, Open  ]],
Cell[CellGroupData[{
Cell[97970, 2468, 913, 23, 293, "Input"],
Cell[98886, 2493, 880, 29, 40, "Output"]
}, Open  ]]
}, Open  ]]
}, Open  ]]
}, Open  ]]
}
]
*)

